[{"id":"1710a13e.24be0f","type":"tab","label":"START","disabled":false,"info":""},{"id":"b5c91dfd.5442f","type":"tab","label":"ONBOARDING","disabled":false,"info":""},{"id":"e6eb5d0f.a5faf","type":"tab","label":"MAIN MENU","disabled":false,"info":""},{"id":"4ebce18b.d28be","type":"tab","label":"POPULAR","disabled":false,"info":""},{"id":"aa705505.e4b1e8","type":"tab","label":"TOP_RETED","disabled":false,"info":""},{"id":"b3c092ec.f386c","type":"tab","label":"NOW_PLAYING","disabled":false,"info":""},{"id":"9b0ebb1.f61dc48","type":"tab","label":"PROFIL","disabled":false,"info":""},{"id":"6e4c635c.e9a3cc","type":"subflow","name":"BD Mongo","info":"","category":"","in":[{"x":320,"y":240,"wires":[{"id":"eca77b34.7ed2a8"}]}],"out":[{"x":1220,"y":220,"wires":[{"id":"599d4ef2.5ef4a","port":0},{"id":"2696d184.602f2e","port":0},{"id":"2e35eea3.4e66c2","port":0},{"id":"edfbe89a.afcaa8","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"26039c45.5709e4","type":"mongodb3","z":"6e4c635c.e9a3cc","uri":"mongodb+srv://filmoteka:filmoteka121212@cluster0.ybwuc.mongodb.net/films_bd","name":"films","options":"","parallelism":"-1"},{"id":"1dcca23.b38bf5e","type":"function","z":"1710a13e.24be0f","name":"Send message","func":"msg.fbToken = \"EAADABZBqmUFsBAGdZCy6z2G0QubZC2sKAR68aXX4wOTBKVboaVj5G07G2GMuUlmR01TxwDbaKXEYLH9dKZAJ244juZBMpdKhAfHYufsWfyrTgEm6V3kbRk3UcIOYurHH9OuJISZBZA4CeE7fZCskXjoCMFcJMZAuliSFpZAe4jvYFcpAZDZD\"\nmsg.url = \"https://graph.facebook.com/v9.0/me/messages?access_token=\" + msg.fbToken\n// msg.url = \"https://graph.facebook.com/v9.0/me/messaging_postbacks?access_token=\" + msg.fbToken\nmsg.method = \"POST\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":980,"y":60,"wires":[["60480cbc.da8904"]]},{"id":"c68c1a52.3896c8","type":"debug","z":"1710a13e.24be0f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":290,"y":20,"wires":[]},{"id":"1946a459.12c13c","type":"http in","z":"1710a13e.24be0f","name":"Messenger Verification Webhook","url":"/filmoteka","method":"get","upload":false,"swaggerDoc":"","x":150,"y":80,"wires":[["c68c1a52.3896c8","fd649286.0a99"]]},{"id":"fd649286.0a99","type":"function","z":"1710a13e.24be0f","name":"Subscribe","func":"let mode = '';\nlet VERIFY_TOKEN = \"filmoteka_token\"\nlet challenge = '';\nif (msg.payload['hub.mode']) \n{\n    mode = msg.payload['hub.mode'];\n}\nif (msg.payload['hub.verify_token']) \n{\n    vtoken = msg.payload['hub.verify_token'];\n}\nif (msg.payload['hub.challenge']) \n{\n    challenge = msg.payload['hub.challenge'];\n}\nif ('subscribe' == mode && VERIFY_TOKEN) {\n    msg.payload = challenge;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":380,"y":80,"wires":[["a0f4944b.222f18"]]},{"id":"a0f4944b.222f18","type":"http response","z":"1710a13e.24be0f","name":"","statusCode":"200","headers":{},"x":560,"y":80,"wires":[]},{"id":"c5535df2.52373","type":"http in","z":"1710a13e.24be0f","name":"Messenger Chat Listener","url":"/filmoteka","method":"post","upload":false,"swaggerDoc":"","x":150,"y":340,"wires":[["cc0e191e.218f48","1fcd737b.aeb4cd","23741206.89a9be"]]},{"id":"1fcd737b.aeb4cd","type":"debug","z":"1710a13e.24be0f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":170,"y":460,"wires":[]},{"id":"cc0e191e.218f48","type":"http response","z":"1710a13e.24be0f","name":"","statusCode":"200","headers":{},"x":200,"y":420,"wires":[]},{"id":"60480cbc.da8904","type":"http request","z":"1710a13e.24be0f","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1190,"y":60,"wires":[["e88651ad.4952f"]]},{"id":"23741206.89a9be","type":"change","z":"1710a13e.24be0f","name":"","rules":[{"t":"set","p":"recipient","pt":"msg","to":"payload.entry[0].messaging[0].sender.id","tot":"msg"},{"t":"set","p":"reply","pt":"msg","to":"payload.entry[0].messaging[0].message.quick_reply.payload","tot":"msg"},{"t":"set","p":"postback","pt":"msg","to":"payload.entry[0].messaging[0].postback.payload","tot":"msg"},{"t":"set","p":"apiKey","pt":"msg","to":"0706e3f4bbf4b68e2b9170ad810a2feb","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":340,"wires":[["96a883e6.eba2b"]]},{"id":"f223bc38.1c8fb","type":"link in","z":"1710a13e.24be0f","name":"send_message","links":["5f4a80a3.ed3b8","8e7cf187.ffec8","b6d714f9.f10528","c20186f6.1a9058","cd5ab50d.3ffc58","84157aa0.7607a8","f090c164.ddb8f","cb5e00e6.7a992","bad6bf4f.51918","7f615395.5b175c","5483a43f.9cfadc","7b11c274.fd5c2c","9f976cf1.78a55","70d3189e.b78388","9cd64418.d91d08","41868697.9233c8","d661e52b.b4c188","823053f7.c55e9","47a23282.7cb1bc","780ad033.80c8d","90c668b2.e637e8","53b994b2.69ee8c","ae55dafb.b1d8a8","bf45375.3b9d0c8","a969ad0.3967a5"],"x":815,"y":60,"wires":[["1dcca23.b38bf5e"]]},{"id":"f85b81fd.0892b","type":"switch","z":"1710a13e.24be0f","name":"reply","property":"reply","propertyType":"msg","rules":[{"t":"eq","v":"popular","vt":"str"},{"t":"eq","v":"top_rated","vt":"str"},{"t":"eq","v":"now_playing","vt":"str"},{"t":"eq","v":"profil","vt":"str"},{"t":"eq","v":"bakProfil","vt":"str"},{"t":"cont","v":"nextPopular","vt":"str"},{"t":"cont","v":"nextTopRated","vt":"str"},{"t":"cont","v":"nextNowPlaying","vt":"str"},{"t":"eq","v":"mainMenu","vt":"str"},{"t":"eq","v":"goRevised","vt":"str"},{"t":"eq","v":"goLook","vt":"str"},{"t":"cont","v":"nextRevised","vt":"str"},{"t":"cont","v":"prewRevised","vt":"str"},{"t":"cont","v":"nextLook","vt":"str"},{"t":"cont","v":"prewLook","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":16,"x":1350,"y":340,"wires":[["59792454.3b952c"],["317b9c22.8f3a74"],["fa674dee.f2296"],["3215ee90.6bcba2"],["3215ee90.6bcba2"],["ecb302af.a41c"],["14266bb.1ff5794"],["8bd63488.f27d88"],["594a74c1.a7d56c"],["b60c4c35.5918b"],["9060d750.5e7618"],["fe52b374.49a65"],["e3d37844.0229c8"],["5807961a.c7dc38"],["420c234b.f06a0c"],["4411056a.70d24c"]]},{"id":"bb059c66.0590f","type":"function","z":"e6eb5d0f.a5faf","name":"mainMenu","func":"msg.state = \"mainMenu\"\nmsg.payload = {\n    \"recipient\":{\n        \"id\":msg.recipient\n},\n\"messaging_type\": \"RESPONSE\",\n    \"message\": {\n        \"text\": `${msg.first_name ? msg.first_name : \"Друже\"}! Цей бот допоможе тобі вибрати фільм🎬 Тут зібрана база всіх новинок і не тільки😉 Тому скоріше переходь до вибору фільмів😜`,\n        \"quick_replies\":[\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Популярні ✨\",\n            \"payload\":\"popular\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Рейтингові 🏆\",\n            \"payload\":\"top_rated\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Зараз дивляться 📺\",\n            \"payload\":\"now_playing\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Мій кабінет 🎬\",\n            \"payload\":\"profil\"\n            },\n        ]\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":270,"y":220,"wires":[["cd5ab50d.3ffc58","441c3a7b.620344","a4e26e41.8f97b"]]},{"id":"cd5ab50d.3ffc58","type":"link out","z":"e6eb5d0f.a5faf","name":"send_message","links":["f223bc38.1c8fb"],"x":395,"y":180,"wires":[]},{"id":"73008930.f3bf58","type":"link in","z":"e6eb5d0f.a5faf","name":"mainMenu","links":["594a74c1.a7d56c","4769cb9e.9548d4","c1b0af96.113c2","5d498699.3108d8","d6f044af.6cea68","96826726.f9f658","85130728.64f4b8","da18c1c4.b4447"],"x":115,"y":220,"wires":[["bb059c66.0590f"]]},{"id":"594a74c1.a7d56c","type":"link out","z":"1710a13e.24be0f","name":"mainMenu","links":["73008930.f3bf58","640ead20.3f7794"],"x":1555,"y":420,"wires":[]},{"id":"c480d56c.07c018","type":"link in","z":"b3c092ec.f386c","name":"now_playing","links":["fa674dee.f2296","9bff31ff.eaddb"],"x":215,"y":240,"wires":[["e8963ca2.489ba"]]},{"id":"fa674dee.f2296","type":"link out","z":"1710a13e.24be0f","name":"now_playing","links":["c480d56c.07c018"],"x":1555,"y":220,"wires":[]},{"id":"317b9c22.8f3a74","type":"link out","z":"1710a13e.24be0f","name":"top","links":["c94d4650.4904f8","3758799d.9aa596"],"x":1555,"y":180,"wires":[]},{"id":"1b06cfb1.87d9c","type":"function","z":"4ebce18b.d28be","name":"GET Popular_films API","func":"\nlet lang = 'uk-UA'\nlet length = msg.reply ? Number(msg.reply.split(\"_\")[3])-1 : Number(msg.payload.page.split(\"_\")[3])-1\nif(msg.reply ? Number(msg.reply.split(\"_\")[1]) === length : Number(msg.payload.page.split(\"_\")[1]) === length){\n    msg.pageNext = msg.reply ? 1+Number(msg.reply.split(\"_\")[2]) : 1+Number(msg.payload.page.split(\"_\")[2]);\n    msg.reply = `nextPopular_1_${msg.pageNext}`\n}else{\n    if(msg.reply ? Number(msg.reply.split(\"_\")[2]) > 1 : Number(msg.payload.page.split(\"_\")[2]) > 1){\n        msg.pageNext = msg.reply ? Number(msg.reply.split(\"_\")[2]) : Number(msg.payload.page.split(\"_\")[2])\n    }else{\n        msg.pageNext = 1\n    }\n}\n\nmsg.url = `https://api.themoviedb.org/3/movie/popular?api_key=${msg.apiKey}&language=${lang}&page=${msg.pageNext}`\nmsg.method = \"GET\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":360,"y":180,"wires":[["4fb4a68f.386008","6054f878.2e5e18"]]},{"id":"4fb4a68f.386008","type":"http request","z":"4ebce18b.d28be","name":"","method":"use","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":550,"y":180,"wires":[["bd5a6153.b1e73","6054f878.2e5e18"]]},{"id":"cb5e00e6.7a992","type":"link out","z":"4ebce18b.d28be","name":"","links":["f223bc38.1c8fb"],"x":1395,"y":220,"wires":[]},{"id":"d8492c88.cf1f","type":"link in","z":"4ebce18b.d28be","name":"popular","links":["59792454.3b952c","6f04c2cb.e6296c"],"x":155,"y":140,"wires":[["1b06cfb1.87d9c","facfd4a.d74ae28","897cb5b4.0a0638"]]},{"id":"59792454.3b952c","type":"link out","z":"1710a13e.24be0f","name":"popular","links":["d8492c88.cf1f","b67aeb78.078838","928d5a45.f95138"],"x":1555,"y":140,"wires":[]},{"id":"eca77b34.7ed2a8","type":"switch","z":"6e4c635c.e9a3cc","name":"insert, update, find, del","property":"switch_type","propertyType":"msg","rules":[{"t":"eq","v":"insert","vt":"str"},{"t":"eq","v":"update","vt":"str"},{"t":"eq","v":"find","vt":"str"},{"t":"eq","v":"del","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":520,"y":240,"wires":[["599d4ef2.5ef4a"],["2696d184.602f2e"],["2e35eea3.4e66c2"],["edfbe89a.afcaa8"]]},{"id":"599d4ef2.5ef4a","type":"mongodb3 in","z":"6e4c635c.e9a3cc","service":"_ext_","configNode":"26039c45.5709e4","name":"","collection":"","operation":"insert","x":770,"y":160,"wires":[[]]},{"id":"2696d184.602f2e","type":"mongodb3 in","z":"6e4c635c.e9a3cc","service":"_ext_","configNode":"26039c45.5709e4","name":"","collection":"","operation":"findOneAndUpdate","x":810,"y":200,"wires":[[]]},{"id":"2e35eea3.4e66c2","type":"mongodb3 in","z":"6e4c635c.e9a3cc","service":"_ext_","configNode":"26039c45.5709e4","name":"","collection":"","operation":"findOne","x":770,"y":240,"wires":[[]]},{"id":"edfbe89a.afcaa8","type":"mongodb3 in","z":"6e4c635c.e9a3cc","service":"_ext_","configNode":"26039c45.5709e4","name":"","collection":"","operation":"findOneAndDelete","x":810,"y":280,"wires":[[]]},{"id":"ecb302af.a41c","type":"link out","z":"1710a13e.24be0f","name":"nextPopular","links":["d3c703d2.61876","57dd1ee3.6b3f8","b664acee.e9a09"],"x":1555,"y":300,"wires":[]},{"id":"d3c703d2.61876","type":"link in","z":"4ebce18b.d28be","name":"nextPopular","links":["ecb302af.a41c"],"x":155,"y":240,"wires":[["1b06cfb1.87d9c"]]},{"id":"5227e3a1.61a96c","type":"link in","z":"aa705505.e4b1e8","name":"nextTopRated","links":["14266bb.1ff5794","aefea340.bb5e2"],"x":215,"y":400,"wires":[["549ef7e5.afa518"]]},{"id":"14266bb.1ff5794","type":"link out","z":"1710a13e.24be0f","name":"nextTopRated","links":["5227e3a1.61a96c","38a8f572.6e5a8a"],"x":1555,"y":340,"wires":[]},{"id":"c94d4650.4904f8","type":"link in","z":"aa705505.e4b1e8","name":"top","links":["317b9c22.8f3a74"],"x":215,"y":300,"wires":[["549ef7e5.afa518"]]},{"id":"b30c358f.071198","type":"link in","z":"b3c092ec.f386c","name":"nextNowPlaying","links":["8bd63488.f27d88"],"x":215,"y":340,"wires":[["e8963ca2.489ba"]]},{"id":"8bd63488.f27d88","type":"link out","z":"1710a13e.24be0f","name":"nextNowPlaying","links":["b30c358f.071198"],"x":1555,"y":380,"wires":[]},{"id":"3215ee90.6bcba2","type":"link out","z":"1710a13e.24be0f","name":"profil","links":["4e2f7f5c.a2f99"],"x":1555,"y":260,"wires":[]},{"id":"4e2f7f5c.a2f99","type":"link in","z":"9b0ebb1.f61dc48","name":"profil","links":["3215ee90.6bcba2","42f8463c.207c28","fa66e9f0.c4ca08","66a28c16.2112c4"],"x":235,"y":220,"wires":[["c5cbf27c.0a9ba"]]},{"id":"c5cbf27c.0a9ba","type":"function","z":"9b0ebb1.f61dc48","name":"profil","func":"msg.state = \"profil\"\nmsg.payload = {\n    \"recipient\":{\n        \"id\":msg.recipient\n},\n\"messaging_type\": \"RESPONSE\",\n    \"message\": {\n        \"text\": `Це твій кабінет🛋 Тут зібрані фільми, які ти плануєш переглянути😁, а також ті, які вже переглянув😍 `,\n        \"quick_replies\":[\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Планую переглянути😁\",\n            \"payload\":\"goRevised\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Переглянуті😍\",\n            \"payload\":\"goLook\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Головне меню ↩\",\n            \"payload\":\"mainMenu\"\n            },\n        ]\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":410,"y":220,"wires":[["5483a43f.9cfadc","211ea1e3.b651de","39d61a31.562276"]]},{"id":"5483a43f.9cfadc","type":"link out","z":"9b0ebb1.f61dc48","name":"send_message","links":["f223bc38.1c8fb"],"x":515,"y":180,"wires":[]},{"id":"4411056a.70d24c","type":"switch","z":"1710a13e.24be0f","name":"postback","property":"postback","propertyType":"msg","rules":[{"t":"eq","v":"start","vt":"str"},{"t":"eq","v":"mainMenu","vt":"str"},{"t":"eq","v":"profil","vt":"str"},{"t":"eq","v":"goRevised","vt":"str"},{"t":"eq","v":"goLook","vt":"str"},{"t":"cont","v":"what","vt":"str"},{"t":"cont","v":"look","vt":"str"},{"t":"cont","v":"delete","vt":"str"},{"t":"cont","v":"golk","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":10,"x":1500,"y":840,"wires":[["39853dd3.38bd42"],["85130728.64f4b8"],["42f8463c.207c28"],["2819bd1a.7f93c2"],["6f73b5db.72b32c"],["54cf4f02.28e59"],["a29c0f81.a4e8"],["9c142522.e0c788"],["3feda72e.da4f78"],["29579bf5.7dd124","316d578d.a23158"]]},{"id":"29579bf5.7dd124","type":"debug","z":"1710a13e.24be0f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1330,"y":980,"wires":[]},{"id":"19950024.c13ba","type":"link in","z":"9b0ebb1.f61dc48","name":"revised","links":["54cf4f02.28e59","aab335f3.0fbf28","7a91cc37.833b04"],"x":235,"y":320,"wires":[["1403a4b0.9ee84b","333beee1.5cd822"]]},{"id":"608a5f3c.5f583","type":"link in","z":"9b0ebb1.f61dc48","name":"look","links":["a29c0f81.a4e8","303cb466.61507c","fd640c5f.12aae","3feda72e.da4f78","aa63eedc.6c19c"],"x":235,"y":520,"wires":[["1d329bd.b50cd64","659e347c.51d85c"]]},{"id":"54cf4f02.28e59","type":"link out","z":"1710a13e.24be0f","name":"revised","links":["19950024.c13ba"],"x":1715,"y":880,"wires":[]},{"id":"a29c0f81.a4e8","type":"link out","z":"1710a13e.24be0f","name":"look","links":["608a5f3c.5f583"],"x":1715,"y":920,"wires":[]},{"id":"2ef6c279.56dcee","type":"function","z":"9b0ebb1.f61dc48","name":"","func":"msg.rev = msg.payload.revised.find(a => a.filmId === msg.postback.split(\"_\")[1])\nmsg.page = msg.payload.page\nmsg.state = msg.payload.state\nif(!msg.rev){\n    msg.switch_type = \"update\";\n    msg.collection = 'users';\n    let films = {\"revised\": {\n        filmId: msg.postback.split(\"_\")[1],\n        poster_path: msg.postback.split(\"_\")[3],\n        title: msg.postback.split(\"_\")[2],\n        vote_average: msg.postback.split(\"_\")[4],\n    }};\n    let bd = {recipient: msg.recipient};\n    // let newData = {revised: [filmID]}\n    msg.payload =[\n        bd,{$push: films},{ upsert:true, returnNewDocument : true }\n    ];\n}else{\n    msg.payload = {}\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":720,"y":320,"wires":[["d10f55c4.b69928"]]},{"id":"8adf0bfb.1f3298","type":"subflow:6e4c635c.e9a3cc","z":"9b0ebb1.f61dc48","name":"","env":[],"x":1070,"y":280,"wires":[["78d00338.83b5bc"]]},{"id":"1403a4b0.9ee84b","type":"function","z":"9b0ebb1.f61dc48","name":"find_recipient","func":"msg.switch_type = \"find\";\nmsg.collection = 'users';\nlet bd = {recipient: msg.recipient};\nmsg.payload = bd;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":320,"wires":[["1dd6ec04.d28b84"]]},{"id":"1dd6ec04.d28b84","type":"subflow:6e4c635c.e9a3cc","z":"9b0ebb1.f61dc48","name":"","x":550,"y":320,"wires":[["2ef6c279.56dcee","728965ab.d278fc"]]},{"id":"a9c2b938.e8aac8","type":"function","z":"b5c91dfd.5442f","name":"saveUser","func":"msg.switch_type = \"insert\";\nmsg.collection = 'users';\nmsg.payload = {\n    recipient: msg.recipient,\n    first_name: msg.first_name,\n    last_name: msg.last_name,\n    revised: [],\n    look: []\n};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":820,"y":260,"wires":[["9b17db97.341b68"]]},{"id":"9b17db97.341b68","type":"subflow:6e4c635c.e9a3cc","z":"b5c91dfd.5442f","name":"","x":1000,"y":260,"wires":[["c1b0af96.113c2","a64070e6.ae22b"]]},{"id":"8f00577c.1b58d8","type":"function","z":"b5c91dfd.5442f","name":"find_recipient","func":"msg.switch_type = \"find\";\nmsg.collection = 'users';\nlet bd = {recipient: msg.recipient};\nmsg.payload = bd;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":330,"y":260,"wires":[["3047c849.705548"]]},{"id":"3047c849.705548","type":"subflow:6e4c635c.e9a3cc","z":"b5c91dfd.5442f","name":"","x":510,"y":260,"wires":[["e0fbbcbf.97fc8"]]},{"id":"e0fbbcbf.97fc8","type":"switch","z":"b5c91dfd.5442f","name":"","property":"payload","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":260,"wires":[["a9c2b938.e8aac8"],["c1b0af96.113c2"]]},{"id":"39853dd3.38bd42","type":"link out","z":"1710a13e.24be0f","name":"start","links":["d984c0b8.167f9","8440a1d4.680ea"],"x":1715,"y":680,"wires":[]},{"id":"d984c0b8.167f9","type":"link in","z":"b5c91dfd.5442f","name":"start","links":["39853dd3.38bd42"],"x":175,"y":260,"wires":[["8f00577c.1b58d8"]]},{"id":"c1b0af96.113c2","type":"link out","z":"b5c91dfd.5442f","name":"mainMenu","links":["73008930.f3bf58","640ead20.3f7794"],"x":1135,"y":260,"wires":[]},{"id":"d10f55c4.b69928","type":"switch","z":"9b0ebb1.f61dc48","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":320,"wires":[["8adf0bfb.1f3298"],["6f2cfb6e.b116b4"]]},{"id":"fee9e085.5611","type":"function","z":"9b0ebb1.f61dc48","name":"","func":"msg.lok = msg.payload.look.find(a => a.filmId === msg.postback.split(\"_\")[1])\nmsg.page = msg.payload.page\nmsg.state = msg.payload.state\nif(!msg.lok){\n    msg.switch_type = \"update\";\n    msg.collection = 'users';\n    let films = {\"look\": {\n        filmId: msg.postback.split(\"_\")[1],\n        poster_path: msg.postback.split(\"_\")[3],\n        title: msg.postback.split(\"_\")[2],\n        vote_average: msg.postback.split(\"_\")[4],\n    }};\n    let bd = {recipient: msg.recipient};\n    // let newData = {revised: [filmID]}\n    msg.payload =[\n        bd,{$push: films},{ upsert:true, returnNewDocument : true }\n    ];\n}else{\n    msg.payload = {}\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":720,"y":520,"wires":[["4ef15e0.ad022a4"]]},{"id":"82806133.8affc","type":"debug","z":"9b0ebb1.f61dc48","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":270,"y":1300,"wires":[]},{"id":"4a41a66d.05f1e8","type":"subflow:6e4c635c.e9a3cc","z":"9b0ebb1.f61dc48","name":"","env":[],"x":1050,"y":480,"wires":[["79fc2723.371d58"]]},{"id":"1d329bd.b50cd64","type":"function","z":"9b0ebb1.f61dc48","name":"find_recipient","func":"msg.switch_type = \"find\";\nmsg.collection = 'users';\nlet bd = {recipient: msg.recipient};\nmsg.payload = bd;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":520,"wires":[["2b9e7103.fddeae"]]},{"id":"2b9e7103.fddeae","type":"subflow:6e4c635c.e9a3cc","z":"9b0ebb1.f61dc48","name":"","x":550,"y":520,"wires":[["4c2fc5a9.06593c","fee9e085.5611"]]},{"id":"4ef15e0.ad022a4","type":"switch","z":"9b0ebb1.f61dc48","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":890,"y":520,"wires":[["4a41a66d.05f1e8"],["276f5fd1.07859"]]},{"id":"87a1434a.f9281","type":"link in","z":"9b0ebb1.f61dc48","name":"goRevised","links":["b60c4c35.5918b","fe52b374.49a65","e3d37844.0229c8","cdde388e.f0f5b8","6059cee5.f8455","467353ac.816a1c","e6679780.b3cbf8","e4998ec4.8d37f","2819bd1a.7f93c2"],"x":235,"y":780,"wires":[["24c6e6cd.8f057a","e74560f5.18e6f"]]},{"id":"2ca1cee6.114952","type":"link in","z":"9b0ebb1.f61dc48","name":"goLook","links":["420c234b.f06a0c","5807961a.c7dc38","9060d750.5e7618","6ef28fe4.4d9e1","f8c3e942.d52808","6f73b5db.72b32c"],"x":235,"y":1180,"wires":[["b98fd1d8.543d8","b9858329.1967a"]]},{"id":"b60c4c35.5918b","type":"link out","z":"1710a13e.24be0f","name":"goRevised","links":["87a1434a.f9281","3a25f29e.2f64be"],"x":1555,"y":460,"wires":[]},{"id":"9060d750.5e7618","type":"link out","z":"1710a13e.24be0f","name":"goLook","links":["2ca1cee6.114952","9575e9a9.e8c3c8"],"x":1555,"y":500,"wires":[]},{"id":"24c6e6cd.8f057a","type":"function","z":"9b0ebb1.f61dc48","name":"find_recipient","func":"msg.switch_type = \"find\";\nmsg.collection = 'users';\nlet bd = {recipient: msg.recipient};\nmsg.payload = bd;\nmsg.state = \"goRevised\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":780,"wires":[["3d83e688.a3bb9a"]]},{"id":"3d83e688.a3bb9a","type":"subflow:6e4c635c.e9a3cc","z":"9b0ebb1.f61dc48","name":"","env":[],"x":550,"y":780,"wires":[["eab6856b.87f428"]]},{"id":"b98fd1d8.543d8","type":"function","z":"9b0ebb1.f61dc48","name":"find_recipient","func":"msg.switch_type = \"find\";\nmsg.collection = 'users';\nlet bd = {recipient: msg.recipient};\nmsg.payload = bd;\nmsg.state = \"goLook\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":1180,"wires":[["9663f5b0.369cd8"]]},{"id":"9663f5b0.369cd8","type":"subflow:6e4c635c.e9a3cc","z":"9b0ebb1.f61dc48","name":"","x":550,"y":1180,"wires":[["f467608.6aef7a","471bd191.4f2a1"]]},{"id":"78d00338.83b5bc","type":"function","z":"9b0ebb1.f61dc48","name":"PreMenuAdd","func":"msg.payload = {\n    \"recipient\":{\n        \"id\":msg.recipient\n},\n\"messaging_type\": \"RESPONSE\",\n    \"message\": {\n        \"text\": \"Фільм успішно додано!😉\",\n        \"quick_replies\":[\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Наступний ⏭\",\n            \"payload\":msg.page\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Популярні ✨\",\n            \"payload\":\"popular\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Рейтингові 🏆\",\n            \"payload\":\"top_rated\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Зараз дивляться 📺\",\n            \"payload\":\"now_playing\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Мій кабінет 🎬\",\n            \"payload\":\"profil\"\n            },\n        ]\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1270,"y":280,"wires":[["7b11c274.fd5c2c","30c08ebd.31ab22","3688b97c.6c87d6"]]},{"id":"7384c0d2.7a831","type":"function","z":"9b0ebb1.f61dc48","name":"PreMenuAdd","func":"msg.payload = {\n    \"recipient\":{\n        \"id\":msg.recipient\n},\n\"messaging_type\": \"RESPONSE\",\n    \"message\": {\n        \"text\": \"Фільм успішно додано!😉\",\n        \"quick_replies\":[\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Наступний ⏭\",\n            \"payload\":msg.page\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Популярні ✨\",\n            \"payload\":\"popular\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Рейтингові 🏆\",\n            \"payload\":\"top_rated\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Зараз дивляться 📺\",\n            \"payload\":\"now_playing\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Мій кабінет 🎬\",\n            \"payload\":\"profil\"\n            },\n        ]\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1350,"y":500,"wires":[["9f976cf1.78a55","7c9247df.73e878","6228d5e5.8dd3fc"]]},{"id":"7b11c274.fd5c2c","type":"link out","z":"9b0ebb1.f61dc48","name":"","links":["f223bc38.1c8fb"],"x":1375,"y":360,"wires":[]},{"id":"9f976cf1.78a55","type":"link out","z":"9b0ebb1.f61dc48","name":"","links":["f223bc38.1c8fb"],"x":1515,"y":620,"wires":[]},{"id":"6f2cfb6e.b116b4","type":"function","z":"9b0ebb1.f61dc48","name":"PreMenuNoAdd","func":"msg.payload = {\n    \"recipient\":{\n        \"id\":msg.recipient\n},\n\"messaging_type\": \"RESPONSE\",\n    \"message\": {\n        \"text\": \"Цей фільм вже знаходиться у вашому кабінеті😎\",\n        \"quick_replies\":[\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Наступний ⏭\",\n            \"payload\":msg.page\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Популярні ✨\",\n            \"payload\":\"popular\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Рейтингові 🏆\",\n            \"payload\":\"top_rated\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Зараз дивляться 📺\",\n            \"payload\":\"now_playing\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Мій кабінет 🎬\",\n            \"payload\":\"profil\"\n            },\n        ]\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1100,"y":360,"wires":[["7b11c274.fd5c2c","30c08ebd.31ab22","3688b97c.6c87d6"]]},{"id":"31f21948.d3dfd6","type":"function","z":"9b0ebb1.f61dc48","name":"PreMenuNoAdd","func":"msg.payload = {\n    \"recipient\":{\n        \"id\":msg.recipient\n},\n\"messaging_type\": \"RESPONSE\",\n    \"message\": {\n        \"text\": \"Цей фільм вже знаходиться у вашому кабінеті😎\",\n        \"quick_replies\":[\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Наступний ⏭\",\n            \"payload\":msg.page\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Популярні ✨\",\n            \"payload\":\"popular\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Рейтингові 🏆\",\n            \"payload\":\"top_rated\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Зараз дивляться 📺\",\n            \"payload\":\"now_playing\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Мій кабінет 🎬\",\n            \"payload\":\"profil\"\n            },\n        ]\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1200,"y":620,"wires":[["9f976cf1.78a55","7c9247df.73e878","6228d5e5.8dd3fc"]]},{"id":"22812674.24a7fa","type":"function","z":"9b0ebb1.f61dc48","name":"films_list","func":"if(msg.reply === \"prewRevised1\"){\n    msg.arr = msg.payload.revised.slice(10)\n}else{\n    msg.arr = msg.payload.revised\n}\n\nif(msg.arr.length > 10){\n    if(msg.reply === \"prewRevised1\"){\n        msg.rep = [\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n      },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Попередні ⏮\",\n        \"payload\":`prewRevised`\n        },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Наступні ⏭\",\n        \"payload\":\"nextRevised1\"\n      },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Назад ⬅\",\n        \"payload\":`bakProfil`\n      }\n      ]\n    }else{\n        msg.rep = [\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n      },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Наступні ⏭\",\n        \"payload\":\"nextRevised\"\n      },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Назад ⬅\",\n        \"payload\":`bakProfil`\n      }\n      ]\n    }\n    msg.arr.length = 10\n}else{\n     msg.rep = [\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n        },\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Назад ⬅\",\n        \"payload\":`bakProfil`\n      },\n      ]\n}\n\nmsg.element = msg.arr.map(a=>\n    (\n        {\n            \"title\": `${a.title}`,\n            \"image_url\":`https://image.tmdb.org/t/p/w500/${a.poster_path}`,\n            \"subtitle\":`Рейтинг: ${a.vote_average}`,\n            \"buttons\":[\n              {\n                \"type\":\"web_url\",\n                \"url\":`https://www.themoviedb.org/movie/${a.filmId}`,\n                \"title\":\"Детальніше\",\n                \"webview_height_ratio\": \"tall\",\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Вже переглянутий\",\n                \"payload\":`golk_${a.filmId}_${a.title}_${a.poster_path}_${a.vote_average}`\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Видалити\",\n                \"payload\":`delete_${a.filmId}_revised`\n              }\n            ]      \n        }\n    ))\n\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"message\":{\n    \"attachment\":{\n      \"type\":\"template\",\n      \"payload\":{\n        \"template_type\":\"generic\",\n        \"image_aspect_ratio\": \"square\",\n        \"elements\": msg.element\n      }\n    },\n    \"quick_replies\": msg.rep\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1160,"y":780,"wires":[["d661e52b.b4c188","7382436c.c9debc","15b0aba6.6ced84"]]},{"id":"d5d5e309.be60a","type":"function","z":"b5c91dfd.5442f","name":"saveUser","func":"msg.switch_type = \"insert\";\nmsg.collection = 'films';\nmsg.payload = {\n    recipient: msg.recipient,\n    films: [{\n        filmId: \"\",\n        poster_path: \"\",\n        title: \"\",\n        vote_average:\"\"\n    }]\n};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":820,"y":320,"wires":[["4dc80280.0c9eac"]]},{"id":"4dc80280.0c9eac","type":"subflow:6e4c635c.e9a3cc","z":"b5c91dfd.5442f","name":"","x":1000,"y":320,"wires":[[]]},{"id":"6ba61fe8.0bbef","type":"function","z":"b5c91dfd.5442f","name":"find_recipient","func":"msg.switch_type = \"find\";\nmsg.collection = 'films';\nlet bd = {recipient: msg.recipient};\nmsg.payload = bd;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":330,"y":320,"wires":[["d0fee1ed.50dfd"]]},{"id":"d0fee1ed.50dfd","type":"subflow:6e4c635c.e9a3cc","z":"b5c91dfd.5442f","name":"","x":510,"y":320,"wires":[["c1f046f5.8fda78"]]},{"id":"c1f046f5.8fda78","type":"switch","z":"b5c91dfd.5442f","name":"","property":"payload","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":320,"wires":[["d5d5e309.be60a"],[]]},{"id":"eab6856b.87f428","type":"switch","z":"9b0ebb1.f61dc48","name":"","property":"msg.payload.revised","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":910,"y":780,"wires":[["bcbf2c86.31583"],["d584deb6.522a7"]]},{"id":"f467608.6aef7a","type":"switch","z":"9b0ebb1.f61dc48","name":"","property":"msg.payload.look","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":730,"y":1180,"wires":[["41e47bc1.e93f04"],["45f01577.5af72c"]]},{"id":"45f01577.5af72c","type":"function","z":"9b0ebb1.f61dc48","name":"PreMenuNoAdd","func":"msg.payload = {\n    \"recipient\":{\n        \"id\":msg.recipient\n},\n\"messaging_type\": \"RESPONSE\",\n    \"message\": {\n        \"text\": \"У тебе тут ще не має фільмів🤷‍♂️\",\n        \"quick_replies\":[\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Популярні ✨\",\n            \"payload\":\"popular\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Рейтингові 🏆\",\n            \"payload\":\"top_rated\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Зараз дивляться 📺\",\n            \"payload\":\"now_playing\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Назад ⬅\",\n            \"payload\":\"bakProfil\"\n            },\n        ]\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":920,"y":1220,"wires":[["823053f7.c55e9","6361d067.bd331","79965f56.f490d"]]},{"id":"d584deb6.522a7","type":"function","z":"9b0ebb1.f61dc48","name":"PreMenuNoAdd","func":"msg.payload = {\n    \"recipient\":{\n        \"id\":msg.recipient\n},\n\"messaging_type\": \"RESPONSE\",\n    \"message\": {\n        \"text\": \"У тебе тут ще не має фільмів🤷‍♂️\",\n        \"quick_replies\":[\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Популярні ✨\",\n            \"payload\":\"popular\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Рейтингові 🏆\",\n            \"payload\":\"top_rated\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Зараз дивляться 📺\",\n            \"payload\":\"now_playing\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Назад ⬅\",\n            \"payload\":\"bakProfil\"\n            },\n        ]\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1140,"y":860,"wires":[["d661e52b.b4c188","7382436c.c9debc","15b0aba6.6ced84"]]},{"id":"9c142522.e0c788","type":"link out","z":"1710a13e.24be0f","name":"deletFilms","links":["ab4807af.533418"],"x":1715,"y":960,"wires":[]},{"id":"ab4807af.533418","type":"link in","z":"9b0ebb1.f61dc48","name":"deletFilms","links":["9c142522.e0c788","d5d63095.df371","24ff4718.30f498","273a25e2.ca9c5a","1081b0fb.830b0f"],"x":235,"y":1360,"wires":[["82806133.8affc","b9fb1c6e.0e8b9"]]},{"id":"bf9f01ef.0d213","type":"function","z":"e6eb5d0f.a5faf","name":"saveUser","func":"msg.switch_type = \"insert\";\nmsg.collection = 'users';\nmsg.payload = {\n    recipient: msg.recipient,\n    first_name: msg.first_name,\n    last_name: msg.last_name,\n    revised: [],\n    look: []\n};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":980,"y":220,"wires":[["c6d008c6.af32b8"]]},{"id":"c6d008c6.af32b8","type":"subflow:6e4c635c.e9a3cc","z":"e6eb5d0f.a5faf","name":"","x":1160,"y":220,"wires":[[]]},{"id":"441c3a7b.620344","type":"function","z":"e6eb5d0f.a5faf","name":"find_recipient","func":"msg.switch_type = \"find\";\nmsg.collection = 'users';\nlet bd = {recipient: msg.recipient};\nmsg.payload = bd;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":490,"y":220,"wires":[["ec3c48dd.f439d8"]]},{"id":"ec3c48dd.f439d8","type":"subflow:6e4c635c.e9a3cc","z":"e6eb5d0f.a5faf","name":"","x":670,"y":220,"wires":[["818af853.d432b8","8550c161.8d3e7"]]},{"id":"818af853.d432b8","type":"switch","z":"e6eb5d0f.a5faf","name":"","property":"payload","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":830,"y":220,"wires":[["bf9f01ef.0d213"],[]]},{"id":"e74560f5.18e6f","type":"debug","z":"9b0ebb1.f61dc48","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":350,"y":900,"wires":[]},{"id":"fe52b374.49a65","type":"link out","z":"1710a13e.24be0f","name":"goRevised","links":["87a1434a.f9281","3a25f29e.2f64be"],"x":1555,"y":540,"wires":[]},{"id":"bcbf2c86.31583","type":"switch","z":"9b0ebb1.f61dc48","name":"","property":"msg.reply","propertyType":"msg","rules":[{"t":"cont","v":"nextRevised","vt":"str"},{"t":"cont","v":"prewRevised","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1010,"y":720,"wires":[["6c929a7.d60a764"],["22812674.24a7fa"],["22812674.24a7fa"]]},{"id":"6c929a7.d60a764","type":"function","z":"9b0ebb1.f61dc48","name":"films_list","func":"msg.arr = msg.payload.revised\n\nif(msg.reply === \"nextRevised1\"){\n    msg.nextArr = msg.arr.slice(20)\n}else{\n    msg.nextArr = msg.arr.slice(10)\n}\n\n\nif(msg.nextArr.length > 10){\n    if(msg.reply === \"nextRevised1\"){\n        msg.rev = [\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n        },\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Попередні ⏮\",\n        \"payload\":`prewRevised1`\n        },\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Наступні ⏭\",\n        \"payload\":`nextRevised1`\n        },\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Назад ⬅\",\n        \"payload\":`bakProfil`\n      }\n      ]}else{\n          msg.rev = [\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n        },\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Попередні ⏮\",\n        \"payload\":`prewRevised`\n        },\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Наступні ⏭\",\n        \"payload\":`nextRevised1`\n        },\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Назад ⬅\",\n        \"payload\":`bakProfil`\n      }\n      ]\n      }\n    msg.nextArr.length = 10\n}else{\n    if(msg.reply === \"nextRevised1\"){\n        msg.rev = [\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Головне меню ↩\",\n            \"payload\":\"mainMenu\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Попередні ⏮\",\n            \"payload\":`prewRevised1`\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Назад ⬅\",\n            \"payload\":`bakProfil`\n          }\n          ]\n    }else{\n         msg.rev = [\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Головне меню ↩\",\n            \"payload\":\"mainMenu\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Попередні ⏮\",\n            \"payload\":`prewRevised`\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Назад ⬅\",\n            \"payload\":`bakProfil`\n          }\n          ]\n    }\n}\n\nmsg.element = msg.nextArr.map(a=>\n    (\n        {\n            \"title\": `${a.title}`,\n            \"image_url\":`https://image.tmdb.org/t/p/w500/${a.poster_path}`,\n            \"subtitle\":`Рейтинг: ${a.vote_average}`,\n            \"buttons\":[\n              {\n                \"type\":\"web_url\",\n                \"url\":`https://www.themoviedb.org/movie/${a.filmId}`,\n                \"title\":\"Детальніше\",\n                \"webview_height_ratio\": \"tall\",\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Вже переглянутий\",\n                \"payload\":`golk_${a.filmId}_${a.title}_${a.poster_path}_${a.vote_average}`\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Видалити\",\n                \"payload\":`delete_${a.filmId}_revised`\n              }\n            ]      \n        }\n    ))\n\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"message\":{\n    \"attachment\":{\n      \"type\":\"template\",\n      \"payload\":{\n        \"template_type\":\"generic\",\n        \"image_aspect_ratio\": \"square\",\n        \"elements\": msg.element\n      }\n    },\n    \"quick_replies\": msg.rev\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1160,"y":680,"wires":[["d661e52b.b4c188","7382436c.c9debc","15b0aba6.6ced84"]]},{"id":"e3d37844.0229c8","type":"link out","z":"1710a13e.24be0f","name":"goRevised","links":["87a1434a.f9281","3a25f29e.2f64be"],"x":1555,"y":580,"wires":[]},{"id":"2341e96a.a478f6","type":"function","z":"9b0ebb1.f61dc48","name":"films_list","func":"if(msg.reply === \"prewLook1\"){\n    msg.arr = msg.payload.look.slice(10)\n}else{\n    msg.arr = msg.payload.look\n}\n\nif(msg.arr.length > 10){\n    if(msg.reply === \"prewLook1\"){\n        msg.rep = [\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n      },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Попередні ⏮\",\n        \"payload\":`prewLook`\n        },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Наступні ⏭\",\n        \"payload\":\"nextLook1\"\n      },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Назад ⬅\",\n        \"payload\":`bakProfil`\n      }\n      ]\n    }else{\n        msg.rep = [\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n      },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Наступні ⏭\",\n        \"payload\":\"nextLook\"\n      },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Назад ⬅\",\n        \"payload\":`bakProfil`\n      }\n      ]\n    }\n    msg.arr.length = 10\n}else{\n     msg.rep = [\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n        },\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Назад ⬅\",\n        \"payload\":`bakProfil`\n      },\n      ]\n}\n\nmsg.element = msg.arr.map(a=>\n    (\n        {\n            \"title\": `${a.title}`,\n            \"image_url\":`https://image.tmdb.org/t/p/w500/${a.poster_path}`,\n            \"subtitle\":`Рейтинг: ${a.vote_average}`,\n            \"buttons\":[\n              {\n                \"type\":\"web_url\",\n                \"url\":`https://www.themoviedb.org/movie/${a.filmId}`,\n                \"title\":\"Детальніше\",\n                \"webview_height_ratio\": \"tall\",\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Видалити\",\n                \"payload\":`delete_${a.filmId}_golok`\n              }\n            ]      \n        }\n    ))\n\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"message\":{\n    \"attachment\":{\n      \"type\":\"template\",\n      \"payload\":{\n        \"template_type\":\"generic\",\n        \"image_aspect_ratio\": \"square\",\n        \"elements\": msg.element\n      }\n    },\n    \"quick_replies\": msg.rep\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":940,"y":1120,"wires":[["823053f7.c55e9","6361d067.bd331","79965f56.f490d"]]},{"id":"823053f7.c55e9","type":"link out","z":"9b0ebb1.f61dc48","name":"","links":["f223bc38.1c8fb"],"x":1195,"y":1120,"wires":[]},{"id":"41e47bc1.e93f04","type":"switch","z":"9b0ebb1.f61dc48","name":"","property":"msg.reply","propertyType":"msg","rules":[{"t":"cont","v":"nextLook","vt":"str"},{"t":"cont","v":"prewLook","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":790,"y":1060,"wires":[["46a4630b.99b11c"],["2341e96a.a478f6"],["2341e96a.a478f6"]]},{"id":"46a4630b.99b11c","type":"function","z":"9b0ebb1.f61dc48","name":"films_list","func":"msg.arr = msg.payload.look\n\nif(msg.reply === \"nextLook1\"){\n    msg.nextArr = msg.arr.slice(20)\n}else{\n    msg.nextArr = msg.arr.slice(10)\n}\n\n\nif(msg.nextArr.length > 10){\n    if(msg.reply === \"nextRevised1\"){\n        msg.rev = [\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n        },\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Попередні ⏮\",\n        \"payload\":`prewLook1`\n        },\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Наступні ⏭\",\n        \"payload\":`nextLoolk1`\n        },\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Назад ⬅\",\n        \"payload\":`bakProfil`\n      }\n      ]}else{\n          msg.rev = [\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n        },\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Попередні ⏮\",\n        \"payload\":`prewLook`\n        },\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Наступні ⏭\",\n        \"payload\":`nextLook1`\n        },\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Назад ⬅\",\n        \"payload\":`bakProfil`\n      }\n      ]\n      }\n    msg.nextArr.length = 10\n}else{\n    if(msg.reply === \"nextLook1\"){\n        msg.rev = [\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Головне меню ↩\",\n            \"payload\":\"mainMenu\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Попередні ⏮\",\n            \"payload\":`prewLook1`\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Назад ⬅\",\n            \"payload\":`bakProfil`\n          }\n          ]\n    }else{\n         msg.rev = [\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Головне меню ↩\",\n            \"payload\":\"mainMenu\"\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Попередні ⏮\",\n            \"payload\":`prewLook`\n            },\n            {\n            \"content_type\":\"text\",\n            \"title\":\"Назад ⬅\",\n            \"payload\":`bakProfil`\n          }\n          ]\n    }\n}\n\nmsg.element = msg.nextArr.map(a=>\n    (\n        {\n            \"title\": `${a.title}`,\n            \"image_url\":`https://image.tmdb.org/t/p/w500/${a.poster_path}`,\n            \"subtitle\":`Рейтинг: ${a.vote_average}`,\n            \"buttons\":[\n              {\n                \"type\":\"web_url\",\n                \"url\":`https://www.themoviedb.org/movie/${a.filmId}`,\n                \"title\":\"Детальніше\",\n                \"webview_height_ratio\": \"tall\",\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Видалити\",\n                \"payload\":`delete_${a.filmId}_golok`\n              }\n            ]      \n        }\n    ))\n\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"message\":{\n    \"attachment\":{\n      \"type\":\"template\",\n      \"payload\":{\n        \"template_type\":\"generic\",\n        \"image_aspect_ratio\": \"square\",\n        \"elements\": msg.element\n      }\n    },\n    \"quick_replies\": msg.rev\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":940,"y":1020,"wires":[["823053f7.c55e9","6361d067.bd331","79965f56.f490d"]]},{"id":"5807961a.c7dc38","type":"link out","z":"1710a13e.24be0f","name":"goLook","links":["2ca1cee6.114952","9575e9a9.e8c3c8"],"x":1555,"y":620,"wires":[]},{"id":"420c234b.f06a0c","type":"link out","z":"1710a13e.24be0f","name":"goLook","links":["2ca1cee6.114952","9575e9a9.e8c3c8"],"x":1555,"y":660,"wires":[]},{"id":"b9858329.1967a","type":"debug","z":"9b0ebb1.f61dc48","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":350,"y":1100,"wires":[]},{"id":"d661e52b.b4c188","type":"link out","z":"9b0ebb1.f61dc48","name":"","links":["f223bc38.1c8fb"],"x":1355,"y":780,"wires":[]},{"id":"659e347c.51d85c","type":"debug","z":"9b0ebb1.f61dc48","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":426,"y":591,"wires":[]},{"id":"333beee1.5cd822","type":"debug","z":"9b0ebb1.f61dc48","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":388,"y":381,"wires":[]},{"id":"728965ab.d278fc","type":"debug","z":"9b0ebb1.f61dc48","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":730,"y":380,"wires":[]},{"id":"85130728.64f4b8","type":"link out","z":"1710a13e.24be0f","name":"mainMenu","links":["73008930.f3bf58","640ead20.3f7794"],"x":1715,"y":720,"wires":[]},{"id":"42f8463c.207c28","type":"link out","z":"1710a13e.24be0f","name":"goToprofil","links":["4e2f7f5c.a2f99"],"x":1715,"y":760,"wires":[]},{"id":"760961cd.2f80f","type":"function","z":"4ebce18b.d28be","name":"","func":"msg.popular = msg.payload\nmsg.arr = msg.popular.results\nmsg.lengt = msg.arr.length\nlet i = 0\nif(msg.reply.split(\"_\")[0].slice(0,11) === \"nextPopular\"){\n    // if(msg.arr.slice(-1)[0].id === msg.arr[i]){\n    //     msg.pageNext = msg.pageNext+Number(msg.reply.split(\"_\")[2])\n    //     i = 1\n    // }\n    if(msg.reply.split(\"_\")[0].length === 13){\n        i = 1+Number(msg.reply.split(\"_\")[0].slice(-2))\n    }else{\n        i = 1+Number(msg.reply.split(\"_\")[0].slice(-1))\n    }\n}\nmsg.page = `nextPopular${i}_${msg.pageNext}_${msg.lengt}`\n// if(msg.arr.length > 1){\n//     // msg.rep = [\n//     //     {\n//     //     \"content_type\":\"text\",\n//     //     \"title\":\"Головне меню\",\n//     //     \"payload\":\"mainMenu\"\n//     //   },\n//     //   {\n//     //     \"content_type\":\"text\",\n//     //     \"title\":\"Наступні\",\n//     //     \"payload\":\"nextPopular\"\n//     //   },\n//     //   ]\n//     msg.arr.length = 1\n// }\n\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"message\":{\n    \"attachment\":{\n      \"type\":\"template\",\n      \"payload\":{\n        \"template_type\":\"generic\",\n        \"image_aspect_ratio\": \"square\",\n        \"elements\": [{\n            \"title\": `${msg.arr[i].title}`,\n            \"image_url\":`https://image.tmdb.org/t/p/w500/${msg.arr[i].poster_path}`,\n            \"subtitle\":`Рейтинг: ${msg.arr[i].vote_average}`,\n            \"buttons\":[\n              {\n                \"type\":\"web_url\",\n                \"url\":`https://www.themoviedb.org/movie/${msg.arr[i].id}`,\n                \"title\":\"Детальніше\",\n                \"webview_height_ratio\": \"tall\",\n              },{\n                \"type\":\"postback\",\n                \"title\":\"Додати до перегляду\",\n                \"payload\": `what${msg.arr[i].id}_${msg.arr[i].title}_${msg.arr[i].poster_path}_${msg.arr[i].vote_average}`\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Вже переглянутий\",\n                \"payload\":`loolk${msg.arr[i].id}_${msg.arr[i].title}_${msg.arr[i].poster_path}_${msg.arr[i].vote_average}`\n              }\n            ]      \n        }]\n      }\n    },\n    \"quick_replies\":[\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n      },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Наступний ↩\",\n        \"payload\": msg.page\n      },\n    ]\n    // \"quick_replies\":msg.rep\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":420,"y":520,"wires":[["6f7503c9.e0d27c"]]},{"id":"6f7503c9.e0d27c","type":"debug","z":"4ebce18b.d28be","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":550,"y":520,"wires":[]},{"id":"3e111fd0.2caea","type":"function","z":"4ebce18b.d28be","name":"update_page_number","func":"msg.switch_type = \"update\";\nmsg.collection = 'users';\nlet page = {\"page\": msg.page, \"state\": msg.state};\nlet bd = {recipient: msg.recipient};\nmsg.payload =[\n    bd,{$set: page},{ upsert:true, returnNewDocument : true }\n];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1480,"y":140,"wires":[["73700cba.fb1c54"]]},{"id":"622646ba.ed0408","type":"function","z":"4ebce18b.d28be","name":"find_recipient","func":"msg.switch_type = \"find\";\nmsg.collection = 'users';\nlet bd = {recipient: msg.recipient};\nmsg.payload = bd;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":930,"y":180,"wires":[["29bfe8eb.e77f48"]]},{"id":"29bfe8eb.e77f48","type":"subflow:6e4c635c.e9a3cc","z":"4ebce18b.d28be","name":"","env":[],"x":1090,"y":180,"wires":[["bc48b90a.5aee28"]]},{"id":"73700cba.fb1c54","type":"subflow:6e4c635c.e9a3cc","z":"4ebce18b.d28be","name":"","x":1670,"y":140,"wires":[[]]},{"id":"bc48b90a.5aee28","type":"function","z":"4ebce18b.d28be","name":"chak_films","func":"msg.popular = msg.respons.results\nmsg.state = \"popular\"\nfunction comparer(otherArray){\n  return function(current){\n    return otherArray.filter(function(other){\n      return other.filmId == (current.id || current.filmId)\n    }).length === 0;\n  }\n}\nmsg.revised = (msg.payload.revised && msg.payload.look) ? msg.payload.revised.filter(comparer(msg.payload.look)) : []\nmsg.look = (msg.payload.look && msg.payload.revised) ? msg.payload.look.filter(comparer(msg.payload.revised)) : []\nif((msg.payload.revised !== null) && (msg.payload.look !== null)){\n    msg.result = msg.revised.concat(msg.look);\n    msg.arr = msg.popular.filter(comparer(msg.result))\n}else{\n   if(msg.payload.look !== null){\n     msg.arr = msg.popular.filter(comparer(msg.payload.look))  \n   }\n   if(msg.payload.revised !== null){\n     msg.arr = msg.popular.filter(comparer(msg.payload.revised))  \n   }else{\n       msg.arr = msg.popular\n   }\n}\nmsg.lengt = msg.arr.length\nlet i = 0\nif(msg.reply){\nif(msg.reply.split(\"_\")[0].slice(0,11) === \"nextPopular\"){\n    // if(msg.arr.slice(-1)[0].id === msg.arr[i]){\n    //     msg.pageNext = msg.pageNext+Number(msg.reply.split(\"_\")[2])\n    //     i = 1\n    // }\n        i = 1+Number(msg.reply.split(\"_\")[1])\n}\n}else{\n        i = Number(msg.payload.page.split(\"_\")[1])\n}\nmsg.page = `nextPopular_${i}_${msg.pageNext}_${msg.lengt}`\n// if(msg.arr.length > 1){\n//     // msg.rep = [\n//     //     {\n//     //     \"content_type\":\"text\",\n//     //     \"title\":\"Головне меню\",\n//     //     \"payload\":\"mainMenu\"\n//     //   },\n//     //   {\n//     //     \"content_type\":\"text\",\n//     //     \"title\":\"Наступні\",\n//     //     \"payload\":\"nextPopular\"\n//     //   },\n//     //   ]\n//     msg.arr.length = 1\n// }\n\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"message\":{\n    \"attachment\":{\n      \"type\":\"template\",\n      \"payload\":{\n        \"template_type\":\"generic\",\n        \"image_aspect_ratio\": \"square\",\n        \"elements\": [{\n            \"title\": `${msg.arr[i].title}`,\n            \"image_url\":`https://image.tmdb.org/t/p/w500/${msg.arr[i].poster_path}`,\n            \"subtitle\":`Рейтинг: ${msg.arr[i].vote_average}`,\n            \"buttons\":[\n              {\n                \"type\":\"web_url\",\n                \"url\":`https://www.themoviedb.org/movie/${msg.arr[i].id}`,\n                \"title\":\"Детальніше\",\n                \"webview_height_ratio\": \"tall\",\n              },{\n                \"type\":\"postback\",\n                \"title\":\"Додати до перегляду\",\n                \"payload\": `what_${msg.arr[i].id}_${msg.arr[i].title}_${msg.arr[i].poster_path}_${msg.arr[i].vote_average}`\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Вже переглянутий\",\n                \"payload\":`look_${msg.arr[i].id}_${msg.arr[i].title}_${msg.arr[i].poster_path}_${msg.arr[i].vote_average}`\n              }\n            ]      \n        }]\n      }\n    },\n    \"quick_replies\":[\n    //     {\n    //     \"content_type\":\"text\",\n    //     \"title\":\"Головне меню ↩\",\n    //     \"payload\":\"mainMenu\"\n    //   },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Наступний ⏭\",\n        \"payload\": msg.page\n      },\n    ]\n    // \"quick_replies\":msg.rep\n  }\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1270,"y":180,"wires":[["3e111fd0.2caea","cb5e00e6.7a992","c7edbd81.665eb"]]},{"id":"bd5a6153.b1e73","type":"function","z":"4ebce18b.d28be","name":"films_respons","func":"msg.respons = msg.payload\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":740,"y":180,"wires":[["622646ba.ed0408"]]},{"id":"6054f878.2e5e18","type":"debug","z":"4ebce18b.d28be","name":"popular","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":600,"y":260,"wires":[]},{"id":"a803d7ef.e85838","type":"function","z":"4ebce18b.d28be","name":"films_list","func":"msg.popular = JSON.parse(msg.payload)\nmsg.arr = msg.popular.results\nmsg.lengt = msg.arr.length\n\nif(msg.arr.length > 1){\n    // msg.rep = [\n    //     {\n    //     \"content_type\":\"text\",\n    //     \"title\":\"Головне меню\",\n    //     \"payload\":\"mainMenu\"\n    //   },\n    //   {\n    //     \"content_type\":\"text\",\n    //     \"title\":\"Наступні\",\n    //     \"payload\":\"nextPopular\"\n    //   },\n    //   ]\n    msg.arr.length = 1\n}\n\nmsg.element = msg.arr.map(a=>\n    (\n        {\n            \"title\": `${a.title}`,\n            \"image_url\":`https://image.tmdb.org/t/p/w500/${a.poster_path}`,\n            \"subtitle\":`Рейтинг: ${a.vote_average}`,\n            \"buttons\":[\n              {\n                \"type\":\"web_url\",\n                \"url\":`https://www.themoviedb.org/movie/${a.id}`,\n                \"title\":\"Детальніше\",\n                \"webview_height_ratio\": \"tall\",\n              },{\n                \"type\":\"postback\",\n                \"title\":\"Додати до перегляду\",\n                \"payload\": `what${a.id}_${a.title}_${a.poster_path}_${a.vote_average}`\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Вже переглянутий\",\n                \"payload\":`lool${a.id}_${a.title}_${a.poster_path}_${a.vote_average}`\n              }\n            ]      \n        }\n    ))\n\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"message\":{\n    \"attachment\":{\n      \"type\":\"template\",\n      \"payload\":{\n        \"template_type\":\"generic\",\n        \"image_aspect_ratio\": \"square\",\n        \"elements\": msg.element\n      }\n    },\n    \"quick_replies\":[\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n      },\n    ]\n    // \"quick_replies\":msg.rep\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":580,"y":560,"wires":[[]]},{"id":"746ca9ae.22d948","type":"function","z":"4ebce18b.d28be","name":"films_list","func":"msg.popular = JSON.parse(msg.payload)\nmsg.page = msg.popular.page\nmsg.arr2 = msg.popular.results\nmsg.nextFilms = msg.arr2.slice(10)\n\nmsg.element = msg.nextFilms.map(a=>\n    (\n        {\n            \"title\": `${a.title}`,\n            \"image_url\":`https://image.tmdb.org/t/p/w500/${a.poster_path}`,\n            \"subtitle\":`Рейтинг: ${a.vote_average}`,\n            \"buttons\":[\n              {\n                \"type\":\"web_url\",\n                \"url\":`https://www.themoviedb.org/movie/${a.id}`,\n                \"title\":\"Детальніше\",\n                \"webview_height_ratio\": \"tall\",\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Додати до перегляду\",\n                \"payload\":`what${a.id}_${a.title}_${a.poster_path}_${a.vote_average}`\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Вже переглянутий\",\n                \"payload\":`look${a.id}_${a.title}_${a.poster_path}_${a.vote_average}`\n              }\n            ]      \n        }\n    ))\n\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"message\":{\n    \"attachment\":{\n      \"type\":\"template\",\n      \"payload\":{\n        \"template_type\":\"generic\",\n        \"image_aspect_ratio\": \"square\",\n        \"elements\": msg.element\n      }\n    },\n    \"quick_replies\":[\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n      },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Наступні ➡\",\n        \"payload\":`nextPopular${msg.page}`\n      },\n      ]\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":560,"y":600,"wires":[[]]},{"id":"de1fda72.c20a28","type":"delay","z":"4ebce18b.d28be","name":"","pauseType":"delay","timeout":"1500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":400,"y":600,"wires":[["746ca9ae.22d948"]]},{"id":"549ef7e5.afa518","type":"function","z":"aa705505.e4b1e8","name":"GET Popular_films API","func":"\nlet lang = 'uk-UA'\nlet length = msg.reply ? Number(msg.reply.split(\"_\")[3])-1 : Number(msg.payload.page.split(\"_\")[3])-1\nif(msg.reply ? Number(msg.reply.split(\"_\")[1]) === length : Number(msg.payload.page.split(\"_\")[1]) === length){\n    msg.pageNext = msg.reply ? 1+Number(msg.reply.split(\"_\")[2]) : 1+Number(msg.payload.page.split(\"_\")[2]);\n    msg.reply = `nextTopRated_1_${msg.pageNext}`\n}else{\n    if(msg.reply ? Number(msg.reply.split(\"_\")[2]) > 1 : Number(msg.payload.page.split(\"_\")[2]) > 1){\n        msg.pageNext = msg.reply ? Number(msg.reply.split(\"_\")[2]) : Number(msg.payload.page.split(\"_\")[2])\n    }else{\n        msg.pageNext = 1\n    }\n}\nmsg.url = `https://api.themoviedb.org/3/movie/top_rated?api_key=${msg.apiKey}&language=${lang}&page=${msg.pageNext}`\nmsg.method = \"GET\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":340,"wires":[["9d6384a1.6e31f8","3f9e93bf.b4ab2c"]]},{"id":"9d6384a1.6e31f8","type":"http request","z":"aa705505.e4b1e8","name":"","method":"use","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":590,"y":340,"wires":[["9d6e0fe7.affc1","3f9e93bf.b4ab2c"]]},{"id":"90c668b2.e637e8","type":"link out","z":"aa705505.e4b1e8","name":"","links":["f223bc38.1c8fb"],"x":1435,"y":380,"wires":[]},{"id":"2c5cbd9c.ca14d2","type":"function","z":"aa705505.e4b1e8","name":"update_page_number","func":"msg.switch_type = \"update\";\nmsg.collection = 'users';\nlet page = {\"page\": msg.page, \"state\": msg.state};\nlet bd = {recipient: msg.recipient};\nmsg.payload =[\n    bd,{$set: page},{ upsert:true, returnNewDocument : true }\n];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1520,"y":300,"wires":[["91b4039c.0ba49"]]},{"id":"e8dad326.cdc05","type":"function","z":"aa705505.e4b1e8","name":"find_recipient","func":"msg.switch_type = \"find\";\nmsg.collection = 'users';\nlet bd = {recipient: msg.recipient};\nmsg.payload = bd;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":970,"y":340,"wires":[["b4a052e0.981bf"]]},{"id":"b4a052e0.981bf","type":"subflow:6e4c635c.e9a3cc","z":"aa705505.e4b1e8","name":"","env":[],"x":1130,"y":340,"wires":[["51561e3f.df866"]]},{"id":"91b4039c.0ba49","type":"subflow:6e4c635c.e9a3cc","z":"aa705505.e4b1e8","name":"","x":1710,"y":300,"wires":[[]]},{"id":"3f9e93bf.b4ab2c","type":"debug","z":"aa705505.e4b1e8","name":"reted","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":670,"y":440,"wires":[]},{"id":"51561e3f.df866","type":"function","z":"aa705505.e4b1e8","name":"chak_films","func":"msg.popular = msg.respons.results\nmsg.state = \"top\"\nfunction comparer(otherArray){\n  return function(current){\n    return otherArray.filter(function(other){\n      return other.filmId == (current.id || current.filmId)\n    }).length == 0;\n  }\n}\nmsg.revised = (msg.payload.revised && msg.payload.look) ? msg.payload.revised.filter(comparer(msg.payload.look)) : []\nmsg.look = (msg.payload.look && msg.payload.revised) ? msg.payload.look.filter(comparer(msg.payload.revised)) : []\nif((msg.payload.revised !== null) && (msg.payload.look !== null)){\n    msg.result = msg.revised.concat(msg.look);\n    msg.arr = msg.popular.filter(comparer(msg.result))\n}else{\n   if(msg.payload.look !== null){\n     msg.arr = msg.popular.filter(comparer(msg.payload.look))  \n   }\n   if(msg.payload.revised !== null){\n     msg.arr = msg.popular.filter(comparer(msg.payload.revised))  \n   }else{\n       msg.arr = msg.popular\n   }\n}\nmsg.lengt = msg.arr.length\nlet i = 0\nif(msg.reply){\nif(msg.reply.split(\"_\")[0].slice(0,12) === \"nextTopRated\"){\n           i = 1+Number(msg.reply.split(\"_\")[1])\n}\n}else{\n        i = Number(msg.payload.page.split(\"_\")[1])\n}\nmsg.page = `nextTopRated_${i}_${msg.pageNext}_${msg.lengt}`\n// if(msg.arr.length > 1){\n//     // msg.rep = [\n//     //     {\n//     //     \"content_type\":\"text\",\n//     //     \"title\":\"Головне меню\",\n//     //     \"payload\":\"mainMenu\"\n//     //   },\n//     //   {\n//     //     \"content_type\":\"text\",\n//     //     \"title\":\"Наступні\",\n//     //     \"payload\":\"nextPopular\"\n//     //   },\n//     //   ]\n//     msg.arr.length = 1\n// }\n\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"message\":{\n    \"attachment\":{\n      \"type\":\"template\",\n      \"payload\":{\n        \"template_type\":\"generic\",\n        \"image_aspect_ratio\": \"square\",\n        \"elements\": [{\n            \"title\": `${msg.arr[i].title}`,\n            \"image_url\":`https://image.tmdb.org/t/p/w500/${msg.arr[i].poster_path}`,\n            \"subtitle\":`Рейтинг: ${msg.arr[i].vote_average}`,\n            \"buttons\":[\n              {\n                \"type\":\"web_url\",\n                \"url\":`https://www.themoviedb.org/movie/${msg.arr[i].id}`,\n                \"title\":\"Детальніше\",\n                \"webview_height_ratio\": \"tall\",\n              },{\n                \"type\":\"postback\",\n                \"title\":\"Додати до перегляду\",\n                \"payload\": `what_${msg.arr[i].id}_${msg.arr[i].title}_${msg.arr[i].poster_path}_${msg.arr[i].vote_average}`\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Вже переглянутий\",\n                \"payload\":`look_${msg.arr[i].id}_${msg.arr[i].title}_${msg.arr[i].poster_path}_${msg.arr[i].vote_average}`\n              }\n            ]      \n        }]\n      }\n    },\n    \"quick_replies\":[\n    //     {\n    //     \"content_type\":\"text\",\n    //     \"title\":\"Головне меню ↩\",\n    //     \"payload\":\"mainMenu\"\n    //   },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Наступний ⏭\",\n        \"payload\": msg.page\n      },\n    ]\n    // \"quick_replies\":msg.rep\n  }\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1310,"y":340,"wires":[["2c5cbd9c.ca14d2","90c668b2.e637e8","682cbe05.dc9df"]]},{"id":"9d6e0fe7.affc1","type":"function","z":"aa705505.e4b1e8","name":"films_respons","func":"msg.respons = msg.payload\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":780,"y":340,"wires":[["e8dad326.cdc05"]]},{"id":"e8963ca2.489ba","type":"function","z":"b3c092ec.f386c","name":"GET Popular_films API","func":"\nlet lang = 'uk-UA'\nlet length = msg.reply ? Number(msg.reply.split(\"_\")[2])-1 : Number(msg.payload.page.split(\"_\")[2])-1\nif(msg.reply ? Number(msg.reply.split(\"_\")[1]) === length : Number(msg.payload.page.split(\"_\")[1]) === length){\n    msg.pageNext = msg.reply ? 1+Number(msg.reply.split(\"_\")[2]) : 1+Number(msg.payload.page.split(\"_\")[2]);\n    msg.reply = `nextNowPlaying_1_${msg.pageNext}`\n}else{\n    if(msg.reply ? Number(msg.reply.split(\"_\")[2]) > 1 : Number(msg.payload.page.split(\"_\")[2]) > 1){\n        msg.pageNext = msg.reply ? Number(msg.reply.split(\"_\")[2]) : Number(msg.payload.page.split(\"_\")[2])\n    }else{\n        msg.pageNext = 1\n    }\n}\nmsg.url = `https://api.themoviedb.org/3/movie/now_playing?api_key=${msg.apiKey}&language=${lang}&page=${msg.pageNext}`\nmsg.method = \"GET\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":380,"y":280,"wires":[["e3f1798c.8023a8","570eec6a.c82364"]]},{"id":"e3f1798c.8023a8","type":"http request","z":"b3c092ec.f386c","name":"","method":"use","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":570,"y":280,"wires":[["7cf824b8.1c045c","570eec6a.c82364"]]},{"id":"53b994b2.69ee8c","type":"link out","z":"b3c092ec.f386c","name":"","links":["f223bc38.1c8fb"],"x":1415,"y":320,"wires":[]},{"id":"2d70e014.0498e","type":"function","z":"b3c092ec.f386c","name":"update_page_number","func":"msg.switch_type = \"update\";\nmsg.collection = 'users';\nlet page = {\"page\": msg.page, \"state\": msg.state};\nlet bd = {recipient: msg.recipient};\nmsg.payload =[\n    bd,{$set: page},{ upsert:true, returnNewDocument : true }\n];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1500,"y":240,"wires":[["cb9dbdd5.aee13"]]},{"id":"9f194408.7b7198","type":"function","z":"b3c092ec.f386c","name":"find_recipient","func":"msg.switch_type = \"find\";\nmsg.collection = 'users';\nlet bd = {recipient: msg.recipient};\nmsg.payload = bd;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":950,"y":280,"wires":[["be39d618.e21c48"]]},{"id":"be39d618.e21c48","type":"subflow:6e4c635c.e9a3cc","z":"b3c092ec.f386c","name":"","env":[],"x":1110,"y":280,"wires":[["703aa51d.e1647c"]]},{"id":"cb9dbdd5.aee13","type":"subflow:6e4c635c.e9a3cc","z":"b3c092ec.f386c","name":"","x":1710,"y":240,"wires":[[]]},{"id":"570eec6a.c82364","type":"debug","z":"b3c092ec.f386c","name":"NowPlaying","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":530,"y":380,"wires":[]},{"id":"703aa51d.e1647c","type":"function","z":"b3c092ec.f386c","name":"chak_films","func":"msg.popular = msg.respons.results\nmsg.state = \"now\"\nfunction comparer(otherArray){\n  return function(current){\n    return otherArray.filter(function(other){\n      return other.filmId == (current.id || current.filmId)\n    }).length == 0;\n  }\n}\nmsg.revised = (msg.payload.revised && msg.payload.look) ? msg.payload.revised.filter(comparer(msg.payload.look)) : []\nmsg.look = (msg.payload.look && msg.payload.revised) ? msg.payload.look.filter(comparer(msg.payload.revised)) : []\nif((msg.payload.revised !== null) && (msg.payload.look !== null)){\n    msg.result = msg.revised.concat(msg.look);\n    msg.arr = msg.popular.filter(comparer(msg.result))\n}else{\n   if(msg.payload.look !== null){\n     msg.arr = msg.popular.filter(comparer(msg.payload.look))  \n   }\n   if(msg.payload.revised !== null){\n     msg.arr = msg.popular.filter(comparer(msg.payload.revised))  \n   }else{\n       msg.arr = msg.popular\n   }\n}\nmsg.lengt = msg.arr.length\nlet i = 0\nif(msg.reply){\nif(msg.reply.split(\"_\")[0].slice(0,14) === \"nextNowPlaying\"){\n        i = 1+Number(msg.reply.split(\"_\")[1])\n}\n}else{\n        i = Number(msg.payload.page.split(\"_\")[1])\n}\nmsg.page = `nextNowPlaying_${i}_${msg.pageNext}_${msg.lengt}`\n// if(msg.arr.length > 1){\n//     // msg.rep = [\n//     //     {\n//     //     \"content_type\":\"text\",\n//     //     \"title\":\"Головне меню\",\n//     //     \"payload\":\"mainMenu\"\n//     //   },\n//     //   {\n//     //     \"content_type\":\"text\",\n//     //     \"title\":\"Наступні\",\n//     //     \"payload\":\"nextPopular\"\n//     //   },\n//     //   ]\n//     msg.arr.length = 1\n// }\n\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"message\":{\n    \"attachment\":{\n      \"type\":\"template\",\n      \"payload\":{\n        \"template_type\":\"generic\",\n        \"image_aspect_ratio\": \"square\",\n        \"elements\": [{\n            \"title\": `${msg.arr[i].title}`,\n            \"image_url\":`https://image.tmdb.org/t/p/w500/${msg.arr[i].poster_path}`,\n            \"subtitle\":`Рейтинг: ${msg.arr[i].vote_average}`,\n            \"buttons\":[\n              {\n                \"type\":\"web_url\",\n                \"url\":`https://www.themoviedb.org/movie/${msg.arr[i].id}`,\n                \"title\":\"Детальніше\",\n                \"webview_height_ratio\": \"tall\",\n              },{\n                \"type\":\"postback\",\n                \"title\":\"Додати до перегляду\",\n                \"payload\": `what_${msg.arr[i].id}_${msg.arr[i].title}_${msg.arr[i].poster_path}_${msg.arr[i].vote_average}`\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Вже переглянутий\",\n                \"payload\":`look_${msg.arr[i].id}_${msg.arr[i].title}_${msg.arr[i].poster_path}_${msg.arr[i].vote_average}`\n              }\n            ]      \n        }]\n      }\n    },\n    \"quick_replies\":[\n    //     {\n    //     \"content_type\":\"text\",\n    //     \"title\":\"Головне меню ↩\",\n    //     \"payload\":\"mainMenu\"\n    //   },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Наступний ⏭\",\n        \"payload\": msg.page\n      },\n    ]\n    // \"quick_replies\":msg.rep\n  }\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1290,"y":280,"wires":[["2d70e014.0498e","53b994b2.69ee8c","a0a731d5.4e26d"]]},{"id":"7cf824b8.1c045c","type":"function","z":"b3c092ec.f386c","name":"films_respons","func":"msg.respons = msg.payload\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":760,"y":280,"wires":[["9f194408.7b7198"]]},{"id":"eac176f4.402728","type":"function","z":"aa705505.e4b1e8","name":"GET Top_rated_films API","func":"\nlet lang = 'uk-UA'\nlet page = 1;\nlet number = Number(msg.reply.slice(-1))\nmsg.console = msg.reply.slice(0, -1)\nif(msg.reply.slice(0, -1) == \"nextTopRated\"){\n    page = number+1;\n}\nmsg.url = `https://api.themoviedb.org/3/movie/top_rated?api_key=${msg.apiKey}&language=${lang}&page=${page}`\nmsg.method = \"GET\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":497,"y":600,"wires":[["bcfd4c20.6abcc"]]},{"id":"bcfd4c20.6abcc","type":"http request","z":"aa705505.e4b1e8","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":657,"y":600,"wires":[["6f18e872.dada38","f1d3e1b4.e6fc9"]]},{"id":"6f18e872.dada38","type":"function","z":"aa705505.e4b1e8","name":"films_list","func":"msg.popular = JSON.parse(msg.payload)\nmsg.arr = msg.popular.results\nmsg.lengt = msg.arr.length\n\nif(msg.arr.length > 10){\n    // msg.rep = [\n    //     {\n    //     \"content_type\":\"text\",\n    //     \"title\":\"Головне меню\",\n    //     \"payload\":\"mainMenu\"\n    //   },\n    //   {\n    //     \"content_type\":\"text\",\n    //     \"title\":\"Наступні\",\n    //     \"payload\":\"nextPopular\"\n    //   },\n    //   ]\n    msg.arr.length = 10\n}\n\nmsg.element = msg.arr.map(a=>\n    (\n        {\n            \"title\": `${a.title}`,\n            \"image_url\":`https://image.tmdb.org/t/p/w500/${a.poster_path}`,\n            \"subtitle\":`Рейтинг: ${a.vote_average}`,\n            \"buttons\":[\n              {\n                \"type\":\"web_url\",\n                \"url\":`https://www.themoviedb.org/movie/${a.id}`,\n                \"title\":\"Детальніше\",\n                \"webview_height_ratio\": \"tall\",\n              },{\n                \"type\":\"postback\",\n                \"title\":\"Додати до перегляду\",\n                \"payload\":`what${a.id}_${a.title}_${a.poster_path}_${a.vote_average}`\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Вже переглянутий\",\n                \"payload\":`look${a.id}_${a.title}_${a.poster_path}_${a.vote_average}`\n              }         \n            ]      \n        }\n    ))\n\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"message\":{\n    \"attachment\":{\n      \"type\":\"template\",\n      \"payload\":{\n        \"template_type\":\"generic\",\n        \"image_aspect_ratio\": \"square\",\n        \"elements\": msg.element\n      }\n    },\n    \"quick_replies\":[\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n      },\n    ]\n    // \"quick_replies\":msg.rep\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":837,"y":600,"wires":[["ae55dafb.b1d8a8"]]},{"id":"ae55dafb.b1d8a8","type":"link out","z":"aa705505.e4b1e8","name":"","links":["f223bc38.1c8fb"],"x":927,"y":580,"wires":[]},{"id":"85ea4689.c83ec8","type":"function","z":"aa705505.e4b1e8","name":"films_list","func":"msg.popular = JSON.parse(msg.payload)\nmsg.page = msg.popular.page\nmsg.arr2 = msg.popular.results\nmsg.nextFilms = msg.arr2.slice(10)\n\nmsg.element = msg.nextFilms.map(a=>\n    (\n        {\n            \"title\": `${a.title}`,\n            \"image_url\":`https://image.tmdb.org/t/p/w500/${a.poster_path}`,\n            \"subtitle\":`Рейтинг: ${a.vote_average}`,\n            \"buttons\":[\n              {\n                \"type\":\"web_url\",\n                \"url\":`https://www.themoviedb.org/movie/${a.id}`,\n                \"title\":\"Детальніше\",\n                \"webview_height_ratio\": \"tall\",\n              },{\n                \"type\":\"postback\",\n                \"title\":\"Додати до перегляду\",\n                \"payload\":`what${a.id}_${a.title}_${a.poster_path}_${a.vote_average}`\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Вже переглянутий\",\n                \"payload\":`look${a.id}_${a.title}_${a.poster_path}_${a.vote_average}`\n              }                \n            ]      \n        }\n    ))\n\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"message\":{\n    \"attachment\":{\n      \"type\":\"template\",\n      \"payload\":{\n        \"template_type\":\"generic\",\n        \"image_aspect_ratio\": \"square\",\n        \"elements\": msg.element\n      }\n    },\n    \"quick_replies\":[\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n      },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Наступні ➡\",\n        \"payload\":`nextTopRated${msg.page}`\n      },\n      ]\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":877,"y":660,"wires":[["ae55dafb.b1d8a8"]]},{"id":"f1d3e1b4.e6fc9","type":"delay","z":"aa705505.e4b1e8","name":"","pauseType":"delay","timeout":"1500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":737,"y":660,"wires":[["85ea4689.c83ec8"]]},{"id":"abafdaad.04a718","type":"function","z":"b3c092ec.f386c","name":"GET Now_playing_films API","func":"msg.apiKey = \"0706e3f4bbf4b68e2b9170ad810a2feb\"\nlet lang = 'uk-UA'\nlet page = 1;\nlet number = Number(msg.reply.slice(-1))\nmsg.console = msg.reply.slice(0, -1)\nif(msg.reply.slice(0, -1) == \"nextNowPlaying\"){\n    page = number+1;\n}\nmsg.url = `https://api.themoviedb.org/3/movie/now_playing?api_key=${msg.apiKey}&language=${lang}&page=${page}`\nmsg.method = \"GET\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":530,"y":874,"wires":[["5d1cfcf3.64e7b4"]]},{"id":"5d1cfcf3.64e7b4","type":"http request","z":"b3c092ec.f386c","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":710,"y":874,"wires":[["302baf8e.01b98","8c4fb16e.58e33"]]},{"id":"302baf8e.01b98","type":"function","z":"b3c092ec.f386c","name":"films_list","func":"msg.popular = JSON.parse(msg.payload)\nmsg.arr = msg.popular.results\nmsg.lengt = msg.arr.length\n\nif(msg.arr.length > 10){\n    // msg.rep = [\n    //     {\n    //     \"content_type\":\"text\",\n    //     \"title\":\"Головне меню\",\n    //     \"payload\":\"mainMenu\"\n    //   },\n    //   {\n    //     \"content_type\":\"text\",\n    //     \"title\":\"Наступні\",\n    //     \"payload\":\"nextPopular\"\n    //   },\n    //   ]\n    msg.arr.length = 10\n}\n\nmsg.element = msg.arr.map(a=>\n    (\n        {\n            \"title\": `${a.title}`,\n            \"image_url\":`https://image.tmdb.org/t/p/w500/${a.poster_path}`,\n            \"subtitle\":`Рейтинг: ${a.vote_average}`,\n            \"buttons\":[\n              {\n                \"type\":\"web_url\",\n                \"url\":`https://www.themoviedb.org/movie/${a.id}`,\n                \"title\":\"Детальніше\",\n                \"webview_height_ratio\": \"tall\",\n              },{\n                \"type\":\"postback\",\n                \"title\":\"Додати до перегляду\",\n                \"payload\":`what${a.id}_${a.title}_${a.poster_path}_${a.vote_average}`\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Вже переглянутий\",\n                \"payload\":`look${a.id}_${a.title}_${a.poster_path}_${a.vote_average}`\n              }                 \n            ]      \n        }\n    ))\n\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"message\":{\n    \"attachment\":{\n      \"type\":\"template\",\n      \"payload\":{\n        \"template_type\":\"generic\",\n        \"image_aspect_ratio\": \"square\",\n        \"elements\": msg.element\n      }\n    },\n    \"quick_replies\":[\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n      },\n    ]\n    // \"quick_replies\":msg.rep\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":890,"y":874,"wires":[["a969ad0.3967a5"]]},{"id":"a969ad0.3967a5","type":"link out","z":"b3c092ec.f386c","name":"","links":["f223bc38.1c8fb"],"x":980,"y":854,"wires":[]},{"id":"8c4fb16e.58e33","type":"delay","z":"b3c092ec.f386c","name":"","pauseType":"delay","timeout":"1500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":790,"y":934,"wires":[["6cfa03d4.d9dc6c"]]},{"id":"6cfa03d4.d9dc6c","type":"function","z":"b3c092ec.f386c","name":"films_list","func":"msg.popular = JSON.parse(msg.payload)\nmsg.page = msg.popular.page\nmsg.arr2 = msg.popular.results\nmsg.nextFilms = msg.arr2.slice(10)\n\nmsg.element = msg.nextFilms.map(a=>\n    (\n        {\n            \"title\": `${a.title}`,\n            \"image_url\":`https://image.tmdb.org/t/p/w500/${a.poster_path}`,\n            \"subtitle\":`Рейтинг: ${a.vote_average}`,\n            \"buttons\":[\n              {\n                \"type\":\"web_url\",\n                \"url\":`https://www.themoviedb.org/movie/${a.id}`,\n                \"title\":\"Детальніше\",\n                \"webview_height_ratio\": \"tall\",\n              },{\n                \"type\":\"postback\",\n                \"title\":\"Додати до перегляду\",\n                \"payload\":`what${a.id}_${a.title}_${a.poster_path}_${a.vote_average}`\n              },\n              {\n                \"type\":\"postback\",\n                \"title\":\"Вже переглянутий\",\n                \"payload\":`look${a.id}_${a.title}_${a.poster_path}_${a.vote_average}`\n              }                \n            ]      \n        }\n    ))\n\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"message\":{\n    \"attachment\":{\n      \"type\":\"template\",\n      \"payload\":{\n        \"template_type\":\"generic\",\n        \"image_aspect_ratio\": \"square\",\n        \"elements\": msg.element\n      }\n    },\n    \"quick_replies\":[\n        {\n        \"content_type\":\"text\",\n        \"title\":\"Головне меню ↩\",\n        \"payload\":\"mainMenu\"\n      },\n      {\n        \"content_type\":\"text\",\n        \"title\":\"Наступні ➡\",\n        \"payload\":`nextNowPlaying${msg.page}`\n      },\n      ]\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":934,"y":934,"wires":[["a969ad0.3967a5"]]},{"id":"b9fb1c6e.0e8b9","type":"function","z":"9b0ebb1.f61dc48","name":"find_recipient","func":"msg.switch_type = \"find\";\nmsg.collection = 'users';\nlet bd = {recipient: msg.recipient};\nmsg.payload = bd;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":1360,"wires":[["c8ddb508.fac948"]]},{"id":"c8ddb508.fac948","type":"subflow:6e4c635c.e9a3cc","z":"9b0ebb1.f61dc48","name":"","x":550,"y":1360,"wires":[["a4274923.337488","57d65c2e.0c3be4"]]},{"id":"a4274923.337488","type":"debug","z":"9b0ebb1.f61dc48","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":630,"y":1260,"wires":[]},{"id":"57d65c2e.0c3be4","type":"function","z":"9b0ebb1.f61dc48","name":"","func":"msg.console = msg.postback.split(\"_\")[0]\nif((msg.postback.split(\"_\")[0]) === \"golk\"){\n    msg.revised = msg.payload.revised.filter(a => a.filmId !== msg.postback.split(\"_\")[1])\n}\nif(msg.postback.split(\"_\")[2] === \"revised\"){\n    msg.revised = msg.payload.revised.filter(a => a.filmId !== msg.postback.split(\"_\")[1])\n}\nif(msg.postback.split(\"_\")[2] === \"golok\"){\n    msg.look = msg.payload.look.filter(a => a.filmId !== msg.postback.split(\"_\")[1])\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":740,"y":1360,"wires":[["e9dec0b7.ea4bf"]]},{"id":"e9dec0b7.ea4bf","type":"switch","z":"9b0ebb1.f61dc48","name":"","property":"msg.postback","propertyType":"msg","rules":[{"t":"cont","v":"revised","vt":"str"},{"t":"cont","v":"golk","vt":"str"},{"t":"cont","v":"golok","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":887.7777709960938,"y":1360,"wires":[["a93026c1.090ae8"],["a93026c1.090ae8"],["cf1fcc17.21211"]]},{"id":"e1d91dbe.6f433","type":"subflow:6e4c635c.e9a3cc","z":"9b0ebb1.f61dc48","name":"","x":1230,"y":1320,"wires":[["6059cee5.f8455"]]},{"id":"a93026c1.090ae8","type":"function","z":"9b0ebb1.f61dc48","name":"update_revised","func":"msg.switch_type = \"update\";\nmsg.collection = 'users';\nlet revised = {\"revised\": msg.revised};\nlet bd = {recipient: msg.recipient};\nmsg.payload =[\n    bd,{$set: revised},{ upsert:true, returnNewDocument : true }\n];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1040,"y":1320,"wires":[["e1d91dbe.6f433"]]},{"id":"cf1fcc17.21211","type":"function","z":"9b0ebb1.f61dc48","name":"update_look","func":"msg.switch_type = \"update\";\nmsg.collection = 'users';\nlet look = {\"look\": msg.look};\nlet bd = {recipient: msg.recipient};\nmsg.payload =[\n    bd,{$set: look},{ upsert:true, returnNewDocument : true }\n];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1030,"y":1400,"wires":[["fe5d80d6.f3416"]]},{"id":"fe5d80d6.f3416","type":"subflow:6e4c635c.e9a3cc","z":"9b0ebb1.f61dc48","name":"","x":1210,"y":1400,"wires":[["6ef28fe4.4d9e1"]]},{"id":"6059cee5.f8455","type":"link out","z":"9b0ebb1.f61dc48","name":"goRevised","links":["87a1434a.f9281","3a25f29e.2f64be"],"x":1395,"y":1320,"wires":[]},{"id":"6ef28fe4.4d9e1","type":"link out","z":"9b0ebb1.f61dc48","name":"goLook","links":["2ca1cee6.114952","9575e9a9.e8c3c8"],"x":1395,"y":1400,"wires":[]},{"id":"3feda72e.da4f78","type":"link out","z":"1710a13e.24be0f","name":"look","links":["608a5f3c.5f583"],"x":1715,"y":1000,"wires":[]},{"id":"24ff4718.30f498","type":"link out","z":"9b0ebb1.f61dc48","name":"deletFilms","links":["ab4807af.533418"],"x":1135,"y":540,"wires":[]},{"id":"276f5fd1.07859","type":"switch","z":"9b0ebb1.f61dc48","name":"","property":"postback","propertyType":"msg","rules":[{"t":"cont","v":"golk","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1030,"y":560,"wires":[["24ff4718.30f498"],["31f21948.d3dfd6"]]},{"id":"d5d63095.df371","type":"link out","z":"9b0ebb1.f61dc48","name":"deletFilms","links":["ab4807af.533418"],"x":1295,"y":440,"wires":[]},{"id":"79fc2723.371d58","type":"switch","z":"9b0ebb1.f61dc48","name":"","property":"postback","propertyType":"msg","rules":[{"t":"cont","v":"golk","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1190,"y":480,"wires":[["d5d63095.df371"],["7384c0d2.7a831"]]},{"id":"471bd191.4f2a1","type":"debug","z":"9b0ebb1.f61dc48","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":650,"y":1080,"wires":[]},{"id":"4c2fc5a9.06593c","type":"debug","z":"9b0ebb1.f61dc48","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":710,"y":580,"wires":[]},{"id":"96a883e6.eba2b","type":"function","z":"1710a13e.24be0f","name":"","func":"msg.fbToken = \"EAADABZBqmUFsBAGdZCy6z2G0QubZC2sKAR68aXX4wOTBKVboaVj5G07G2GMuUlmR01TxwDbaKXEYLH9dKZAJ244juZBMpdKhAfHYufsWfyrTgEm6V3kbRk3UcIOYurHH9OuJISZBZA4CeE7fZCskXjoCMFcJMZAuliSFpZAe4jvYFcpAZDZD\"\nmsg.url = `https://graph.facebook.com/${msg.recipient}?access_token=${msg.fbToken}`\nmsg.method = \"GET\"\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":600,"y":340,"wires":[["d34baaec.930d38"]]},{"id":"d34baaec.930d38","type":"http request","z":"1710a13e.24be0f","name":"","method":"use","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":760,"y":340,"wires":[["5ab09359.5c456c","d8156575.a9c988"]]},{"id":"5ab09359.5c456c","type":"debug","z":"1710a13e.24be0f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":850,"y":240,"wires":[]},{"id":"d8156575.a9c988","type":"change","z":"1710a13e.24be0f","name":"","rules":[{"t":"set","p":"first_name","pt":"msg","to":"payload.first_name","tot":"msg"},{"t":"set","p":"last_name","pt":"msg","to":"payload.last_name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1020,"y":340,"wires":[["f85b81fd.0892b"]]},{"id":"427aae68.4f3f","type":"function","z":"1710a13e.24be0f","name":"Preloader","func":"msg.fbToken = \"EAADABZBqmUFsBAGdZCy6z2G0QubZC2sKAR68aXX4wOTBKVboaVj5G07G2GMuUlmR01TxwDbaKXEYLH9dKZAJ244juZBMpdKhAfHYufsWfyrTgEm6V3kbRk3UcIOYurHH9OuJISZBZA4CeE7fZCskXjoCMFcJMZAuliSFpZAe4jvYFcpAZDZD\"\nmsg.url = \"https://graph.facebook.com/v9.0/me/messages?access_token=\" + msg.fbToken\nmsg.method = \"POST\"\nmsg.payload = {\n    \"recipient\":{\n    \"id\": msg.recipient\n  },\n  \"sender_action\":\"typing_on\"\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":960,"y":100,"wires":[["60480cbc.da8904"]]},{"id":"5d429bcb.46c1c4","type":"link in","z":"1710a13e.24be0f","name":"send","links":["fae7fe43.47edd","29fbb2bc.0748ce","2a1b2c7.c55b7d4","b04df323.c0314","a14bfbb.b6a9a08","cee52ac7.9b5378","b0eacbf8.43dbb8","62007e3d.f8679","9e70929a.95406","3f9ce986.2eb976","38609992.e8d266","2ce2fe35.fa9712","18f537dd.08e1c8","a4e26e41.8f97b","c7edbd81.665eb","682cbe05.dc9df","a0a731d5.4e26d","30c08ebd.31ab22","7c9247df.73e878","7382436c.c9debc","6361d067.bd331","211ea1e3.b651de"],"x":815,"y":100,"wires":[["427aae68.4f3f"]]},{"id":"fdc17e0e.7e3dd","type":"function","z":"1710a13e.24be0f","name":"Persist menu","func":"msg.fbToken = \"EAADABZBqmUFsBAGdZCy6z2G0QubZC2sKAR68aXX4wOTBKVboaVj5G07G2GMuUlmR01TxwDbaKXEYLH9dKZAJ244juZBMpdKhAfHYufsWfyrTgEm6V3kbRk3UcIOYurHH9OuJISZBZA4CeE7fZCskXjoCMFcJMZAuliSFpZAe4jvYFcpAZDZD\"\nmsg.url = \"https://graph.facebook.com/v10.0/me/custom_user_settings?access_token=\" + msg.fbToken\nmsg.method = \"POST\"\nmsg.payload = {\n    \"psid\": msg.recipient,\n    \"persistent_menu\": [\n        {\n            \"locale\": \"default\",\n            \"composer_input_disabled\": true,\n            \"call_to_actions\": [\n                {\n                    \"type\": \"postback\",\n                    \"title\": \"Головне меню ↩\",\n                    \"payload\": \"mainMenu\"\n                },\n                {\n                    \"type\": \"postback\",\n                    \"title\":\"Планую переглянути😁\",\n                    \"payload\":\"goRevised\"\n                },\n                {\n                    \"type\": \"postback\",\n                    \"title\":\"Переглянуті😍\",\n                    \"payload\":\"goLook\"\n                },\n            ]\n        }\n    ]\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":970,"y":140,"wires":[["60480cbc.da8904"]]},{"id":"11b6dab8.55ffd5","type":"link in","z":"1710a13e.24be0f","name":"Persistent","links":["3cd55d0a.298352","a64070e6.ae22b"],"x":815,"y":140,"wires":[["fdc17e0e.7e3dd"]]},{"id":"a4e26e41.8f97b","type":"link out","z":"e6eb5d0f.a5faf","name":"","links":["5d429bcb.46c1c4"],"x":395,"y":140,"wires":[]},{"id":"c7edbd81.665eb","type":"link out","z":"4ebce18b.d28be","name":"","links":["5d429bcb.46c1c4"],"x":1395,"y":260,"wires":[]},{"id":"682cbe05.dc9df","type":"link out","z":"aa705505.e4b1e8","name":"","links":["5d429bcb.46c1c4"],"x":1435,"y":420,"wires":[]},{"id":"a0a731d5.4e26d","type":"link out","z":"b3c092ec.f386c","name":"","links":["5d429bcb.46c1c4"],"x":1415,"y":360,"wires":[]},{"id":"30c08ebd.31ab22","type":"link out","z":"9b0ebb1.f61dc48","name":"","links":["5d429bcb.46c1c4"],"x":1375,"y":320,"wires":[]},{"id":"7c9247df.73e878","type":"link out","z":"9b0ebb1.f61dc48","name":"","links":["5d429bcb.46c1c4"],"x":1515,"y":580,"wires":[]},{"id":"7382436c.c9debc","type":"link out","z":"9b0ebb1.f61dc48","name":"","links":["5d429bcb.46c1c4"],"x":1355,"y":820,"wires":[]},{"id":"6361d067.bd331","type":"link out","z":"9b0ebb1.f61dc48","name":"","links":["5d429bcb.46c1c4"],"x":1195,"y":1160,"wires":[]},{"id":"211ea1e3.b651de","type":"link out","z":"9b0ebb1.f61dc48","name":"","links":["5d429bcb.46c1c4"],"x":515,"y":260,"wires":[]},{"id":"e34b5fe3.6aa5e","type":"switch","z":"1710a13e.24be0f","name":"State","property":"payload.state","propertyType":"msg","rules":[{"t":"eq","v":"mainMenu","vt":"str"},{"t":"eq","v":"popular","vt":"str"},{"t":"eq","v":"top","vt":"str"},{"t":"eq","v":"now","vt":"str"},{"t":"eq","v":"profil","vt":"str"},{"t":"eq","v":"revised","vt":"str"},{"t":"eq","v":"look","vt":"str"},{"t":"eq","v":"goRevised","vt":"str"},{"t":"eq","v":"goLook","vt":"str"}],"checkall":"true","repair":false,"outputs":9,"x":1890,"y":1160,"wires":[["da18c1c4.b4447"],["6f04c2cb.e6296c"],["aefea340.bb5e2"],["9bff31ff.eaddb"],["fa66e9f0.c4ca08"],["7a91cc37.833b04"],["aa63eedc.6c19c"],["e4998ec4.8d37f"],["f8c3e942.d52808"]]},{"id":"316d578d.a23158","type":"function","z":"1710a13e.24be0f","name":"find_recipient","func":"msg.switch_type = \"find\";\nmsg.collection = 'users';\nlet bd = {recipient: msg.recipient};\nmsg.payload = bd;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1530,"y":1160,"wires":[["7f61705e.22b91"]]},{"id":"7f61705e.22b91","type":"subflow:6e4c635c.e9a3cc","z":"1710a13e.24be0f","name":"","env":[],"x":1690,"y":1160,"wires":[["e34b5fe3.6aa5e"]]},{"id":"da18c1c4.b4447","type":"link out","z":"1710a13e.24be0f","name":"mainMenu","links":["73008930.f3bf58","640ead20.3f7794"],"x":2055,"y":1020,"wires":[]},{"id":"6f04c2cb.e6296c","type":"link out","z":"1710a13e.24be0f","name":"popular","links":["d8492c88.cf1f","b67aeb78.078838","928d5a45.f95138"],"x":2055,"y":1060,"wires":[]},{"id":"9bff31ff.eaddb","type":"link out","z":"1710a13e.24be0f","name":"now_playing","links":["c480d56c.07c018"],"x":2055,"y":1140,"wires":[]},{"id":"aefea340.bb5e2","type":"link out","z":"1710a13e.24be0f","name":"nextTopRated","links":["5227e3a1.61a96c","38a8f572.6e5a8a"],"x":2055,"y":1100,"wires":[]},{"id":"facfd4a.d74ae28","type":"debug","z":"4ebce18b.d28be","name":"popular","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":320,"y":100,"wires":[]},{"id":"8550c161.8d3e7","type":"function","z":"e6eb5d0f.a5faf","name":"saveState","func":"msg.switch_type = \"update\";\nmsg.collection = 'users';\nlet state = {\"state\": msg.state};\nlet bd = {recipient: msg.recipient};\nmsg.payload =[\n    bd,{$set: state},{ upsert:true, returnNewDocument : true }\n];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":840,"y":260,"wires":[["a4933383.1073f"]]},{"id":"a4933383.1073f","type":"subflow:6e4c635c.e9a3cc","z":"e6eb5d0f.a5faf","name":"","x":1010,"y":260,"wires":[[]]},{"id":"39d61a31.562276","type":"function","z":"9b0ebb1.f61dc48","name":"saveState","func":"msg.switch_type = \"update\";\nmsg.collection = 'users';\nlet state = {\"state\": msg.state};\nlet bd = {recipient: msg.recipient};\nmsg.payload =[\n    bd,{$set: state},{ upsert:true, returnNewDocument : true }\n];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":600,"y":220,"wires":[["b8d2068.03670f8"]]},{"id":"b8d2068.03670f8","type":"subflow:6e4c635c.e9a3cc","z":"9b0ebb1.f61dc48","name":"","x":770,"y":220,"wires":[[]]},{"id":"3688b97c.6c87d6","type":"function","z":"9b0ebb1.f61dc48","name":"saveState","func":"msg.switch_type = \"update\";\nmsg.collection = 'users';\nlet state = {\"state\": msg.state};\nlet bd = {recipient: msg.recipient};\nmsg.payload =[\n    bd,{$set: state},{ upsert:true, returnNewDocument : true }\n];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1460,"y":280,"wires":[["9774b5d8.6dce38"]]},{"id":"9774b5d8.6dce38","type":"subflow:6e4c635c.e9a3cc","z":"9b0ebb1.f61dc48","name":"","x":1630,"y":280,"wires":[[]]},{"id":"6228d5e5.8dd3fc","type":"function","z":"9b0ebb1.f61dc48","name":"saveState","func":"msg.switch_type = \"update\";\nmsg.collection = 'users';\nlet state = {\"state\": msg.state};\nlet bd = {recipient: msg.recipient};\nmsg.payload =[\n    bd,{$set: state},{ upsert:true, returnNewDocument : true }\n];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1540,"y":500,"wires":[["466a9c6e.c01c64"]]},{"id":"466a9c6e.c01c64","type":"subflow:6e4c635c.e9a3cc","z":"9b0ebb1.f61dc48","name":"","x":1710,"y":500,"wires":[[]]},{"id":"15b0aba6.6ced84","type":"function","z":"9b0ebb1.f61dc48","name":"saveState","func":"msg.switch_type = \"update\";\nmsg.collection = 'users';\nlet state = {\"state\": msg.state};\nlet bd = {recipient: msg.recipient};\nmsg.payload =[\n    bd,{$set: state},{ upsert:true, returnNewDocument : true }\n];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1480,"y":780,"wires":[["71b94fca.b3b19"]]},{"id":"71b94fca.b3b19","type":"subflow:6e4c635c.e9a3cc","z":"9b0ebb1.f61dc48","name":"","x":1650,"y":780,"wires":[[]]},{"id":"79965f56.f490d","type":"function","z":"9b0ebb1.f61dc48","name":"saveState","func":"msg.switch_type = \"update\";\nmsg.collection = 'users';\nlet state = {\"state\": msg.state};\nlet bd = {recipient: msg.recipient};\nmsg.payload =[\n    bd,{$set: state},{ upsert:true, returnNewDocument : true }\n];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1300,"y":1080,"wires":[["b7d4c5e0.eae748"]]},{"id":"b7d4c5e0.eae748","type":"subflow:6e4c635c.e9a3cc","z":"9b0ebb1.f61dc48","name":"","x":1470,"y":1080,"wires":[[]]},{"id":"aa63eedc.6c19c","type":"link out","z":"1710a13e.24be0f","name":"look","links":["608a5f3c.5f583"],"x":2055,"y":1260,"wires":[]},{"id":"fa66e9f0.c4ca08","type":"link out","z":"1710a13e.24be0f","name":"profil","links":["4e2f7f5c.a2f99"],"x":2055,"y":1180,"wires":[]},{"id":"7a91cc37.833b04","type":"link out","z":"1710a13e.24be0f","name":"revised","links":["19950024.c13ba"],"x":2055,"y":1220,"wires":[]},{"id":"e4998ec4.8d37f","type":"link out","z":"1710a13e.24be0f","name":"goRevised","links":["87a1434a.f9281","3a25f29e.2f64be"],"x":2055,"y":1300,"wires":[]},{"id":"f8c3e942.d52808","type":"link out","z":"1710a13e.24be0f","name":"goLook","links":["2ca1cee6.114952","9575e9a9.e8c3c8"],"x":2055,"y":1340,"wires":[]},{"id":"e88651ad.4952f","type":"debug","z":"1710a13e.24be0f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1370,"y":60,"wires":[]},{"id":"897cb5b4.0a0638","type":"debug","z":"4ebce18b.d28be","name":"popular","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":300,"y":260,"wires":[]},{"id":"a64070e6.ae22b","type":"link out","z":"b5c91dfd.5442f","name":"","links":["11b6dab8.55ffd5"],"x":1135,"y":220,"wires":[]},{"id":"2819bd1a.7f93c2","type":"link out","z":"1710a13e.24be0f","name":"goRevised","links":["87a1434a.f9281","3a25f29e.2f64be"],"x":1715,"y":800,"wires":[]},{"id":"6f73b5db.72b32c","type":"link out","z":"1710a13e.24be0f","name":"goLook","links":["2ca1cee6.114952","9575e9a9.e8c3c8"],"x":1715,"y":840,"wires":[]}]